
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>Ring-builder &#8212; Swift 0.1.0.dev10162 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/basic.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <link rel="canonical" href="/openstack-swift/admin/objectstorage-ringbuilder.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Cluster architecture" href="objectstorage-arch.html" />
    <link rel="prev" title="Components" href="objectstorage-components.html" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- Bootstrap CSS -->
<link href="../_static/css/bootstrap.min.css" rel="stylesheet">

<!-- Fonts -->
<link href="../_static/css/font-awesome.min.css" rel="stylesheet">

<!-- Custom CSS -->
<link href="../_static/css/combined.css" rel="stylesheet">

<!-- Search CSS -->
<link href="../_static/css/search.css" rel="stylesheet">

<!-- Pygments CSS -->
<link href="../_static/pygments.css" rel="stylesheet">

<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

<!-- Google Analytics -->
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-17511903-1', 'auto');
ga('send', 'pageview');
</script>
<!-- End Google Analytics -->


  </head><body>

<!-- SOURCE_FILE: https://opendev.org/openstack/swift/src/doc/source/admin/objectstorage-ringbuilder.rst -->

<script>
    (function (window, document) {
        var loader = function () {
            var script = document.createElement("script"), tag = document.getElementsByTagName("script")[0];
            script.src = "https://search.openstack.org/widget/embed.min.js?t="+Date.now();
            tag.parentNode.insertBefore(script, tag);
        };
        window.addEventListener ? window.addEventListener("load", loader, false) : window.attachEvent("onload", loader);
    })(window, document);
</script>

<nav class="navbar navbar-default" role="navigation">
  <div class="container">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button class="navbar-toggle" data-target="#bs-example-navbar-collapse-1" data-toggle="collapse" type="button">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <div class="brand-wrapper">
        <a class="navbar-brand" href="https://www.openstack.org/"></a>
      </div>
      <div class="search-icon show"><i class="fa fa-search"></i> Search</div></div>
      <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <div class="search-container tiny">
    <div class="openstack-search-bar" data-baseUrl="search.openstack.org" data-context="docs-openstack"></div>
</div>
      <ul class="nav navbar-nav navbar-main show">
        <li class="search-container-mobile">
    <div class="openstack-search-bar" data-baseUrl="search.openstack.org" data-context="docs-openstack"></div>
</li>
        <li> <!--Software -->
          <a href="https://www.openstack.org/software/" class="drop" id="dropdownMenuSoftware">Software <i class="fa fa-caret-down"></i></a>
          <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenuSoftware">
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/software/">Overview</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/software/project-navigator/openstack-components">OpenStack Components</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/software/project-navigator/sdks">SDKs</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/software/project-navigator/deployment-tools">Deployment Tools</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/assets/software/projectmap/openstack-map.pdf" target="_blank">OpenStack Map</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/software/sample-configs/">Sample Configs</a></li>
          </ul>
        </li>
        <li> <!-- Use Cases -->
          <a href="https://www.openstack.org/use-cases/" class="drop" id="dropdownMenuUsers">Use Cases <i class="fa fa-caret-down"></i></a>
          <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenuUsers">
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/use-cases/">Users in Production</a></li>
            <li role="presentation" class="divider"></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/use-cases/bare-metal/">Ironic Bare Metal</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/use-cases/edge-computing/">Edge Computing</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/use-cases/telecoms-and-nfv/">Telecom & NFV</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/use-cases/science/">Science and HPC</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/use-cases/containers/">Containers</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/use-cases/enterprise/">Enterprise</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/surveys/landing">User Survey</a></li>
          </ul>
        </li>
        <li> <!-- Events -->
          <a href="https://www.openstack.org/events/" class="drop" id="dropdownMenuEvents">Events <i class="fa fa-caret-down"></i></a>
          <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenuEvents">
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/summit/">Open Infrastructure Summits</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/ptg/">Project Teams Gathering</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/events/opendev-2020/">OpenDev</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/events/community-events/">Community Events</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/events/openstackdays">OpenStack & OpenInfra Days</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/videos/">Summit Videos</a></li>
          </ul>
        </li>
        <li><!-- Community -->
          <a href="https://www.openstack.org/community/" class="drop" id="dropdownMenuCommunity">Community <i class="fa fa-caret-down"></i></a>
          <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenuCommunity">
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/community/">Welcome! Start Here</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/community/tech-committee">OpenStack Technical Committee</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/community/speakers/">Speakers Bureau</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://wiki.openstack.org">OpenStack Wiki</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/coa/">Get Certified (COA)</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/community/jobs/">Jobs</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/marketing/">Marketing Resources</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/news/">Community News</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://superuser.openstack.org">Superuser Magazine</a></li>
            <li role="presentation" class="divider"></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/community/supporting-organizations/">OpenInfra Foundation Supporting Organizations</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://openinfra.dev">Open Infrastructure Foundation (OpenInfra Foundation)</a></li>
          </ul>
        </li>
        <li><!-- Marketplace -->
          <a href="https://www.openstack.orgmarketplace/" class="drop" id="dropdownMenuLearn">Marketplace <i class="fa fa-caret-down"></i></a>
          <ul class="dropdown-menu dropdown-hover" role="menu" aria-labelledby="dropdownMenuEvents">
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/marketplace/training/">Training</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/marketplace/distros/">Distros & Appliances</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/marketplace/public-clouds/">Public Clouds</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/marketplace/hosted-private-clouds/">Hosted Private Clouds</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/marketplace/remotely-managed-private-clouds/">Remotely Managed Private Clouds</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/marketplace/consulting/">Consulting & Integrators</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/marketplace/drivers/">Drivers</a></li>
          </ul>
        </li>
        <li><!-- Blog -->
          <a href="https://www.openstack.org/blog/">Blog</a>
        </li>
        <li><!-- Docs -->
          <a href="http://docs.openstack.org/">Docs</a>
        </li>
        <li> <!-- Join -->
            <li class="join-nav-section">
              <a href="https://openinfra.dev/join/" id="dropdownMenuJoin">Join <i class="fa fa-caret-down"></i></a>
              <ul class="dropdown-menu dropdown-hover" role="menu" aria-labelledby="dropdownMenuJoin" style="display: none;">
                <li role="presentation"><a role="menuitem" tabindex="-1" href="https://openinfra.dev/join/">Sign up for Foundation Membership</a></li>
                <li role="presentation"><a role="menuitem" tabindex="-1" href="https://openinfra.dev/join/">Sponsor the Foundation</a></li>
                <li role="presentation"><a role="menuitem" tabindex="-1" href="https://openinfra.dev">More about the Foundation</a></li>
              </ul>
            </li>
            <li>
              <a href="https://www.openstack.org/Security/login/?BackURL=/home/" class="sign-in-btn">Log In</a>
            </li>
        </li>
      </ul>
    </div>
  </div>
  <!-- /.container -->
</nav>

    <div class="container docs-book-wrapper">
      <div class="row">
        <div class="col-lg-9 col-md-8 col-sm-8 col-lg-push-3 col-md-push-4 col-sm-push-4">
<div class="row docs-title">
  <div class="col-lg-8">
      <h1>Ring-builder</h1>
    
  </div>
  <div class="docs-actions">
    
    <a href="objectstorage-components.html"><i class="fa fa-angle-double-left" data-toggle="tooltip" data-placement="top" title="Previous: Components"></i></a>
    
    
    <a href="objectstorage-arch.html"><i class="fa fa-angle-double-right" data-toggle="tooltip" data-placement="top" title="Next: Cluster architecture"></i></a>
    
    <a id="pdfLink1" href="" target="_blank" title="Download the manuals as PDF"><i class="fa fa-file-pdf-o" data-toggle="tooltip" data-placement="top" title="Download PDF"></i></a>
    
    <a id="logABugLink1" href="" target="_blank" title="Found an error? Report a bug against this page"><i class="fa fa-bug" data-toggle="tooltip" data-placement="top" title="Report a Bug"></i></a>
    
  </div>
</div>
          <div class="row">
            <div class="col-lg-12">
              <div class="docs-body" role="main">

  <section id="ring-builder">
<h1>Ring-builder<a class="headerlink" href="#ring-builder" title="Permalink to this heading">¶</a></h1>
<p>Use the swift-ring-builder utility to build and manage rings. This
utility assigns partitions to devices and writes an optimized Python
structure to a gzipped, serialized file on disk for transmission to the
servers. The server processes occasionally check the modification time
of the file and reload in-memory copies of the ring structure as needed.
If you use a slightly older version of the ring, one of the three
replicas for a partition subset will be incorrect because of the way the
ring-builder manages changes to the ring. You can work around this
issue.</p>
<p>The ring-builder also keeps its own builder file with the ring
information and additional data required to build future rings. It is
very important to keep multiple backup copies of these builder files.
One option is to copy the builder files out to every server while
copying the ring files themselves. Another is to upload the builder
files into the cluster itself. If you lose the builder file, you have to
create a new ring from scratch. Nearly all partitions would be assigned
to different devices and, therefore, nearly all of the stored data would
have to be replicated to new locations. So, recovery from a builder file
loss is possible, but data would be unreachable for an extended time.</p>
<section id="ring-data-structure">
<h2>Ring data structure<a class="headerlink" href="#ring-data-structure" title="Permalink to this heading">¶</a></h2>
<p>The ring data structure consists of three top level fields: a list of
devices in the cluster, a list of lists of device ids indicating
partition to device assignments, and an integer indicating the number of
bits to shift an MD5 hash to calculate the partition for the hash.</p>
</section>
<section id="partition-assignment-list">
<h2>Partition assignment list<a class="headerlink" href="#partition-assignment-list" title="Permalink to this heading">¶</a></h2>
<p>This is a list of <code class="docutils literal notranslate"><span class="pre">array('H')</span></code> of devices ids. The outermost list
contains an <code class="docutils literal notranslate"><span class="pre">array('H')</span></code> for each replica. Each <code class="docutils literal notranslate"><span class="pre">array('H')</span></code> has a
length equal to the partition count for the ring. Each integer in the
<code class="docutils literal notranslate"><span class="pre">array('H')</span></code> is an index into the above list of devices. The partition
list is known internally to the Ring class as <code class="docutils literal notranslate"><span class="pre">_replica2part2dev_id</span></code>.</p>
<p>So, to create a list of device dictionaries assigned to a partition, the
Python code would look like:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">devices</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">devs</span><span class="p">[</span><span class="n">part2dev_id</span><span class="p">[</span><span class="n">partition</span><span class="p">]]</span> <span class="k">for</span>
<span class="n">part2dev_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_replica2part2dev_id</span><span class="p">]</span>
</pre></div>
</div>
<p>That code is a little simplistic because it does not account for the
removal of duplicate devices. If a ring has more replicas than devices,
a partition will have more than one replica on a device.</p>
<p><code class="docutils literal notranslate"><span class="pre">array('H')</span></code> is used for memory conservation as there may be millions
of partitions.</p>
</section>
<section id="overload">
<h2>Overload<a class="headerlink" href="#overload" title="Permalink to this heading">¶</a></h2>
<p>The ring builder tries to keep replicas as far apart as possible while
still respecting device weights. When it can not do both, the overload
factor determines what happens. Each device takes an extra
fraction of its desired partitions to allow for replica dispersion;
after that extra fraction is exhausted, replicas are placed closer
together than optimal.</p>
<p>The overload factor lets the operator trade off replica
dispersion (durability) against data dispersion (uniform disk usage).</p>
<p>The default overload factor is 0, so device weights are strictly
followed.</p>
<p>With an overload factor of 0.1, each device accepts 10% more
partitions than it otherwise would, but only if it needs to maintain
partition dispersion.</p>
<p>For example, consider a 3-node cluster of machines with equal-size disks;
node A has 12 disks, node B has 12 disks, and node C has
11 disks. The ring has an overload factor of 0.1 (10%).</p>
<p>Without the overload, some partitions would end up with replicas only
on nodes A and B. However, with the overload, every device can accept
up to 10% more partitions for the sake of dispersion. The
missing disk in C means there is one disk’s worth of partitions
to spread across the remaining 11 disks, which gives each
disk in C an extra 9.09% load. Since this is less than the 10%
overload, there is one replica of each partition on each node.</p>
<p>However, this does mean that the disks in node C have more data
than the disks in nodes A and B. If 80% full is the warning
threshold for the cluster, node C’s disks reach 80% full while A
and B’s disks are only 72.7% full.</p>
</section>
<section id="replica-counts">
<h2>Replica counts<a class="headerlink" href="#replica-counts" title="Permalink to this heading">¶</a></h2>
<p>To support the gradual change in replica counts, a ring can have a real
number of replicas and is not restricted to an integer number of
replicas.</p>
<p>A fractional replica count is for the whole ring and not for individual
partitions. It indicates the average number of replicas for each
partition. For example, a replica count of 3.2 means that 20 percent of
partitions have four replicas and 80 percent have three replicas.</p>
<p>The replica count is adjustable. For example:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>swift-ring-builder<span class="w"> </span>account.builder<span class="w"> </span>set_replicas<span class="w"> </span><span class="m">4</span>
<span class="gp">$ </span>swift-ring-builder<span class="w"> </span>account.builder<span class="w"> </span>rebalance
</pre></div>
</div>
<p>You must rebalance the replica ring in globally distributed clusters.
Operators of these clusters generally want an equal number of replicas
and regions. Therefore, when an operator adds or removes a region, the
operator adds or removes a replica. Removing unneeded replicas saves on
the cost of disks.</p>
<p>You can gradually increase the replica count at a rate that does not
adversely affect cluster performance. For example:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>swift-ring-builder<span class="w"> </span>object.builder<span class="w"> </span>set_replicas<span class="w"> </span><span class="m">3</span>.01
<span class="gp">$ </span>swift-ring-builder<span class="w"> </span>object.builder<span class="w"> </span>rebalance
<span class="go">&lt;distribute rings and wait&gt;...</span>

<span class="gp">$ </span>swift-ring-builder<span class="w"> </span>object.builder<span class="w"> </span>set_replicas<span class="w"> </span><span class="m">3</span>.02
<span class="gp">$ </span>swift-ring-builder<span class="w"> </span>object.builder<span class="w"> </span>rebalance
<span class="go">&lt;distribute rings and wait&gt;...</span>
</pre></div>
</div>
<p>Changes take effect after the ring is rebalanced. Therefore, if you
intend to change from 3 replicas to 3.01 but you accidentally type
2.01, no data is lost.</p>
<p>Additionally, the <strong class="command">swift-ring-builder X.builder create</strong> command can
now take a decimal argument for the number of replicas.</p>
</section>
<section id="partition-shift-value">
<h2>Partition shift value<a class="headerlink" href="#partition-shift-value" title="Permalink to this heading">¶</a></h2>
<p>The partition shift value is known internally to the Ring class as
<code class="docutils literal notranslate"><span class="pre">_part_shift</span></code>. This value is used to shift an MD5 hash to calculate
the partition where the data for that hash should reside. Only the top
four bytes of the hash is used in this process. For example, to compute
the partition for the <code class="docutils literal notranslate"><span class="pre">/account/container/object</span></code> path using Python:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">partition</span> <span class="o">=</span> <span class="n">unpack_from</span><span class="p">(</span><span class="s1">&#39;&gt;I&#39;</span><span class="p">,</span>
<span class="n">md5</span><span class="p">(</span><span class="s1">&#39;/account/container/object&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span>
<span class="bp">self</span><span class="o">.</span><span class="n">_part_shift</span>
</pre></div>
</div>
<p>For a ring generated with part_power P, the partition shift value is
<code class="docutils literal notranslate"><span class="pre">32</span> <span class="pre">-</span> <span class="pre">P</span></code>.</p>
</section>
<section id="build-the-ring">
<h2>Build the ring<a class="headerlink" href="#build-the-ring" title="Permalink to this heading">¶</a></h2>
<p>The ring builder process includes these high-level steps:</p>
<ol class="arabic">
<li><p>The utility calculates the number of partitions to assign to each
device based on the weight of the device. For example, for a
partition at the power of 20, the ring has 1,048,576 partitions. One
thousand devices of equal weight each want 1,048.576 partitions. The
devices are sorted by the number of partitions they desire and kept
in order throughout the initialization process.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Each device is also assigned a random tiebreaker value that is
used when two devices desire the same number of partitions. This
tiebreaker is not stored on disk anywhere, and so two different
rings created with the same parameters will have different
partition assignments. For repeatable partition assignments,
<code class="docutils literal notranslate"><span class="pre">RingBuilder.rebalance()</span></code> takes an optional seed value that
seeds the Python pseudo-random number generator.</p>
</div>
</li>
<li><p>The ring builder assigns each partition replica to the device that
requires most partitions at that point while keeping it as far away
as possible from other replicas. The ring builder prefers to assign a
replica to a device in a region that does not already have a replica.
If no such region is available, the ring builder searches for a
device in a different zone, or on a different server. If it does not
find one, it looks for a device with no replicas. Finally, if all
options are exhausted, the ring builder assigns the replica to the
device that has the fewest replicas already assigned.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The ring builder assigns multiple replicas to one device only if
the ring has fewer devices than it has replicas.</p>
</div>
</li>
<li><p>When building a new ring from an old ring, the ring builder
recalculates the desired number of partitions that each device wants.</p></li>
<li><p>The ring builder unassigns partitions and gathers these partitions
for reassignment, as follows:</p>
<ul class="simple">
<li><p>The ring builder unassigns any assigned partitions from any
removed devices and adds these partitions to the gathered list.</p></li>
<li><p>The ring builder unassigns any partition replicas that can be
spread out for better durability and adds these partitions to the
gathered list.</p></li>
<li><p>The ring builder unassigns random partitions from any devices that
have more partitions than they need and adds these partitions to
the gathered list.</p></li>
</ul>
</li>
<li><p>The ring builder reassigns the gathered partitions to devices by
using a similar method to the one described previously.</p></li>
<li><p>When the ring builder reassigns a replica to a partition, the ring
builder records the time of the reassignment. The ring builder uses
this value when it gathers partitions for reassignment so that no
partition is moved twice in a configurable amount of time. The
RingBuilder class knows this configurable amount of time as
<code class="docutils literal notranslate"><span class="pre">min_part_hours</span></code>. The ring builder ignores this restriction for
replicas of partitions on removed devices because removal of a device
happens on device failure only, and reassignment is the only choice.</p></li>
</ol>
<p>These steps do not always perfectly rebalance a ring due to the random
nature of gathering partitions for reassignment. To help reach a more
balanced ring, the rebalance process is repeated until near perfect
(less than 1 percent off) or when the balance does not improve by at
least 1 percent (indicating we probably cannot get perfect balance due
to wildly imbalanced zones or too many partitions recently moved).</p>
</section>
</section>


              </div>
            </div>
          </div>
          <div class="docs-actions">
          
            <a href="objectstorage-components.html"><i class="fa fa-angle-double-left" data-toggle="tooltip" data-placement="top" title="Previous: Components"></i></a>
          
          
            <a href="objectstorage-arch.html"><i class="fa fa-angle-double-right" data-toggle="tooltip" data-placement="top" title="Next: Cluster architecture"></i></a>
          
          <a id="pdfLink2" href="" target="_blank" title="Download the manuals as PDF"><i class="fa fa-file-pdf-o" data-toggle="tooltip" data-placement="top" title="Download PDF"></i></a>
          
            <a id="logABugLink3" href="" target="_blank" title="Found an error? Report a bug against this page"><i class="fa fa-bug" data-toggle="tooltip" data-placement="top" title="Report a Bug"></i></a>
          
          </div>
          <div class="row docs-byline bottom">
            <div class="docs-updated">this page last updated: 2017-07-05 17:04:26</div>
          </div>
          <div class="row">
            <div class="col-lg-8 col-md-8 col-sm-8 docs-license">
<a href="https://creativecommons.org/licenses/by/3.0/">
 <img src="../_static/images/docs/license.png" alt="Creative Commons Attribution 3.0 License"/>
</a>
<p>
 Except where otherwise noted, this document is licensed under
 <a href="https://creativecommons.org/licenses/by/3.0/">Creative Commons
 Attribution 3.0 License</a>. See all <a href="https://www.openstack.org/legal">
 OpenStack Legal Documents</a>.
</p>
            </div>
            <div class="col-lg-4 col-md-4 col-sm-4 docs-actions-wrapper">
            <!-- ID buglinkbottom added so that pre-filled doc bugs
                 are sent to Launchpad projects related to the
                 document -->
              <a href="#" id="logABugLink2" class="docs-footer-actions"><i class="fa fa-bug"></i> found an error? report a bug</a>
            </div>
          </div>
        </div>
<div class="col-lg-3 col-md-4 col-sm-4 col-lg-pull-9 col-md-pull-8 col-sm-pull-8 docs-sidebar">
  <div class="btn-group docs-sidebar-releases">
    <button onclick="location.href='/'" class="btn docs-sidebar-home" data-toggle="tooltip" data-placement="top" title="OpenStack Docs Home"><i class="fa fa-arrow-circle-o-left"></i></button>
<button href="#" type="button" data-toggle="dropdown" class="btn docs-sidebar-release-select">OpenStack Documentation<i class="fa fa-caret-down"></i></button>
    <ul class="dropdown-menu docs-sidebar-dropdown" role="menu" aria-labelledby="dLabel">
      <li role="presentation" class="dropdown-header">Guides</li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="https://docs.openstack.org/index.html#install-guides">Install Guides</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="https://docs.openstack.org/index.html#user-guides">User Guides</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="https://docs.openstack.org/index.html#configuration-guides">Configuration Guides</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="https://docs.openstack.org/index.html#ops-and-admin-guides">Operations and Administration Guides</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="https://docs.openstack.org/index.html#api-guides">API Guides</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="https://docs.openstack.org/index.html#contributor-guides">Contributor Guides</a></li>
      <li role="presentation" class="dropdown-header">Languages</li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="https://docs.openstack.org/de/">Deutsch (German)</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="https://docs.openstack.org/fr/">Français (French)</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="https://docs.openstack.org/id/">Bahasa Indonesia (Indonesian)</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="https://docs.openstack.org/it/">Italiano (Italian)</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="https://docs.openstack.org/ja/">日本語 (Japanese)</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="https://docs.openstack.org/ko_KR/">한국어 (Korean)</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="https://docs.openstack.org/pt_BR/">Português (Portuguese)</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="https://docs.openstack.org/tr_TR/">Türkçe (Türkiye)</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="https://docs.openstack.org/zh_CN/">简体中文 (Simplified Chinese)</a></li>
    </ul>
  </div>
  <div class="docs-sidebar-toc">
    <div class="docs-sidebar-section" id="table-of-contents">
      <a href="../index.html" class="docs-sidebar-section-title"><h4>Swift 0.1.0.dev10162</h4></a>
      <ul>
<li class="toctree-l1"><a class="reference internal" href="../getting_started.html">Getting Started</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api/object_api_v1_overview.html">Object Storage API overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview_architecture.html">Swift Architectural Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview_ring.html">The Rings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview_policies.html">Storage Policies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview_reaper.html">The Account Reaper</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview_auth.html">The Auth System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview_acl.html">Access Control Lists (ACLs)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview_replication.html">Replication</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ratelimit.html">Rate Limiting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview_large_objects.html">Large Object Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview_global_cluster.html">Global Clusters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview_container_sync.html">Container to Container Synchronization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview_expiring_objects.html">Expiring Object Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cors.html">CORS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../crossdomain.html">Cross-domain Policy File</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview_erasure_code.html">Erasure Code Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview_encryption.html">Object Encryption</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview_backing_store.html">Using Swift as Backing Store for Service Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview_container_sharding.html">Container Sharding</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ring_background.html">Building a Consistent Hashing Ring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ring_partpower.html">Modifying Ring Partition Power</a></li>
<li class="toctree-l1"><a class="reference internal" href="../associated_projects.html">Associated Projects</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../contributor/contributing.html">Contributing to OpenStack Swift</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributor/contributing.html#swift-design-principles">Swift Design Principles</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributor/contributing.html#recommended-workflow">Recommended workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributor/contributing.html#notes-on-testing">Notes on Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributor/contributing.html#ideas">Ideas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributor/contributing.html#community">Community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributor/review_guidelines.html">Review Guidelines</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../development_guidelines.html">Development Guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../development_saio.html">SAIO (Swift All In One)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../first_contribution_swift.html">First Contribution to Swift</a></li>
<li class="toctree-l1"><a class="reference internal" href="../policies_saio.html">Adding Storage Policies to an Existing SAIO</a></li>
<li class="toctree-l1"><a class="reference internal" href="../development_auth.html">Auth Server and Middleware</a></li>
<li class="toctree-l1"><a class="reference internal" href="../development_middleware.html">Middleware and Metadata</a></li>
<li class="toctree-l1"><a class="reference internal" href="../development_ondisk_backends.html">Pluggable On-Disk Back-end APIs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../development_watchers.html">Auditor Watchers</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../deployment_guide.html">Deployment Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../apache_deployment_guide.html">Apache Deployment Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../admin_guide.html">Administrator’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../replication_network.html">Dedicated replication network</a></li>
<li class="toctree-l1"><a class="reference internal" href="../logs.html">Logs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ops_runbook/index.html">Swift Ops Runbook</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">OpenStack Swift Administrator Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="objectstorage-intro.html">Introduction to Object Storage</a></li>
<li class="toctree-l2"><a class="reference internal" href="objectstorage-features.html">Features and benefits</a></li>
<li class="toctree-l2"><a class="reference internal" href="objectstorage-characteristics.html">Object Storage characteristics</a></li>
<li class="toctree-l2"><a class="reference internal" href="objectstorage-components.html">Components</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Ring-builder</a></li>
<li class="toctree-l2"><a class="reference internal" href="objectstorage-arch.html">Cluster architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="objectstorage-replication.html">Replication</a></li>
<li class="toctree-l2"><a class="reference internal" href="objectstorage-large-objects.html">Large object support</a></li>
<li class="toctree-l2"><a class="reference internal" href="objectstorage-auditors.html">Object Auditor</a></li>
<li class="toctree-l2"><a class="reference internal" href="objectstorage-EC.html">Erasure coding</a></li>
<li class="toctree-l2"><a class="reference internal" href="objectstorage-account-reaper.html">Account reaper</a></li>
<li class="toctree-l2"><a class="reference internal" href="objectstorage-tenant-specific-image-storage.html">Configure project-specific image locations with Object Storage</a></li>
<li class="toctree-l2"><a class="reference internal" href="objectstorage-monitoring.html">Object Storage monitoring</a></li>
<li class="toctree-l2"><a class="reference internal" href="objectstorage-troubleshoot.html">Troubleshoot Object Storage</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../install/index.html">Object Storage Install Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../config/index.html">Configuration Documentation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api/object_api_v1_overview.html">Object Storage API overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/discoverability.html">Discoverability</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/authentication.html">Authentication</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/container_quotas.html">Container quotas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/object_versioning.html">Object versioning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/large_objects.html">Large objects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/temporary_url_middleware.html">Temporary URL middleware</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/form_post_middleware.html">Form POST middleware</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/use_content-encoding_metadata.html">Use Content-Encoding metadata</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/use_the_content-disposition_metadata.html">Use the Content-Disposition metadata</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/pseudo-hierarchical-folders-directories.html">Pseudo-hierarchical folders and directories</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/pagination.html">Page through large lists of containers or objects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/serialized-response-formats.html">Serialized response formats</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/static-website.html">Create static website</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/object-expiration.html">Object expiration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/bulk-delete.html">Bulk delete</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../s3_compat.html">S3/Swift REST API Comparison Matrix</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../ring.html">Partitioned Consistent Hash Ring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../proxy.html">Proxy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../account.html">Account</a></li>
<li class="toctree-l1"><a class="reference internal" href="../container.html">Container</a></li>
<li class="toctree-l1"><a class="reference internal" href="../db.html">Account DB and Container DB</a></li>
<li class="toctree-l1"><a class="reference internal" href="../object.html">Object</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc.html">Misc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../middleware.html">Middleware</a></li>
<li class="toctree-l1"><a class="reference internal" href="../audit_watchers.html">Object Audit Watchers</a></li>
</ul>

    </div>

  <div class="docs-sidebar-toc">
    <div class="docs-sidebar-section" id="local-table-of-contents">
      <h4 class="docs-sidebar-section-title">Page Contents</h4>
      <ul>
<li><a class="reference internal" href="#">Ring-builder</a><ul>
<li><a class="reference internal" href="#ring-data-structure">Ring data structure</a></li>
<li><a class="reference internal" href="#partition-assignment-list">Partition assignment list</a></li>
<li><a class="reference internal" href="#overload">Overload</a></li>
<li><a class="reference internal" href="#replica-counts">Replica counts</a></li>
<li><a class="reference internal" href="#partition-shift-value">Partition shift value</a></li>
<li><a class="reference internal" href="#build-the-ring">Build the ring</a></li>
</ul>
</li>
</ul>

    </div>
  </div>
  </div>
</div>
      </div>
    </div>
<footer>
  <div class="container">
    <div class="row footer-links">
      <div class="col-lg-2 col-sm-2">
        <h3>OpenStack</h3>
        <ul>
          <li><a href="https://openstack.org/projects/">Projects</a></li>
          <li><a href="https://www.openstack.org/software/security/">OpenStack Security</a></li>
          <li><a href="https://openstack.org/projects/openstack-faq/">Common Questions</a></li>
          <li><a href="https://openstack.org/blog/">Blog</a></li>g
          <li><a href="https://openstack.org/news/">News</a></li>
        </ul>
      </div>
      <div class="col-lg-2 col-sm-2">
        <h3>Community</h3>
        <ul>
          <li><a href="https://openstack.org/community/">User Groups</a></li>
          <li><a href="https://openstack.org/community/events/">Events</a></li>
          <li><a href="https://openstack.org/community/jobs/">Jobs</a></li>
          <li><a href="https://openstack.org/foundation/companies/">Companies</a></li>
          <li><a href="https://docs.openstack.org/contributors">Contribute</a></li>
        </ul>
      </div>
      <div class="col-lg-2 col-sm-2">
        <h3>Documentation</h3>
        <ul>
          <li><a href="https://docs.openstack.org">OpenStack Manuals</a></li>
          <li><a href="https://openstack.org/software/start/">Getting Started</a></li>
          <li><a href="https://developer.openstack.org">API Documentation</a></li>
          <li><a href="https://wiki.openstack.org">Wiki</a></li>
        </ul>
      </div>
      <div class="col-lg-2 col-sm-2">
        <h3>Branding & Legal</h3>
        <ul>
          <li><a href="https://openstack.org/brand/">Logos & Guidelines</a></li>
          <li><a href="https://openstack.org/brand/openstack-trademark-policy/">Trademark Policy</a></li>
          <li><a href="https://openstack.org/privacy/">Privacy Policy</a></li>
          <li><a href="https://wiki.openstack.org/wiki/How_To_Contribute#Contributor_License_Agreement">OpenStack CLA</a></li>
        </ul>
      </div>
      <div class="col-lg-4 col-sm-4">
        <h3>Stay In Touch</h3>
        <a href="https://twitter.com/OpenStack" target="_blank" class="social-icons footer-twitter"></a>
        <a href="https://www.facebook.com/openstack" target="_blank" class="social-icons footer-facebook"></a>
        <a href="https://www.linkedin.com/company/openstack" target="_blank" class="social-icons footer-linkedin"></a>
        <a href="https://www.youtube.com/user/OpenStackFoundation" target="_blank" class="social-icons footer-youtube"></a>
        <p class="fine-print">
          The OpenStack project is provided under the
          <a href="https://www.apache.org/licenses/LICENSE-2.0">Apache 2.0 license</a>. Openstack.org is powered by
          <a href="https://rackspace.com" target="_blank">Rackspace Cloud Computing</a>.
        </p>
      </div>
    </div>
  </div>
</footer>
<!-- jQuery -->
<script type="text/javascript" src="../_static/js/jquery-3.2.1.min.js"></script>

<!-- Bootstrap JavaScript -->
<script type="text/javascript" src="../_static/js/bootstrap.min.js"></script>

<!-- The rest of the JS -->
<script type="text/javascript" src="../_static/js/navigation.js"></script>

<!-- Docs JS -->
<script type="text/javascript" src="../_static/js/docs.js"></script>

<!-- standard sphinx include libraries, which allow search highlighting -->
<script type="text/javascript" src="../_static/underscore.js"></script>
<script type="text/javascript" src="../_static/doctools.js"></script>
<script type="text/javascript" src="../_static/searchtools.js"></script>
<script type="text/javascript" src="../_static/language_data.js"></script>

<script type="text/javascript">
    var DOCUMENTATION_OPTIONS = {
      URL_ROOT:    './',
      VERSION:     '0.1.0.dev10162',
      COLLAPSE_INDEX: false,
      FILE_SUFFIX: '.html',
      LINK_SUFFIX: '.html',
      SOURCELINK_SUFFIX: '.txt',
      HAS_SOURCE:  true
    };
</script>

<!-- Javascript for page -->
<script language="JavaScript">
  /* Build a description of this page including SHA, source location on git
   * repo, build time and the project's launchpad bug tag. Set the HREF of the
   * bug buttons
   */
    var lineFeed = "%0A";
    var gitURL = "Source: Can't derive source file URL";

    /* there have been cases where "pagename" wasn't set; better check for it */
    /* "giturl" is the URL of the source file on Git and is auto-generated by
     * openstackdocstheme.
     *
     * "pagename" is a standard sphinx parameter containing the name of
     * the source file, without extension.
     */

    var sourceFile = "admin/objectstorage-ringbuilder" + ".rst";
    gitURL = "Source: https://opendev.org/openstack/swift/src/doc/source" + "/" + sourceFile;

    /* gitsha, project and bug_tag rely on variables in conf.py */
    var gitSha = "SHA: c25d961319e59efe02c05374924ba82b873992e1";
    var repositoryName = "openstack/swift";
    var bugProject = "swift";
    var bugTitle = "Ring-builder in Swift";
    var fieldTags = "";
    var useStoryboard = "";

    /* "last_updated" is the build date and time. It relies on the
       conf.py variable "html_last_updated_fmt", which should include
       year/month/day as well as hours and minutes                   */
    var buildstring = "Release: 0.1.0.dev10162 on 2017-07-05 17:04:26";

    var fieldComment = encodeURI(buildstring) +
                       lineFeed + encodeURI(gitSha) +
                       lineFeed + encodeURI(gitURL) ;

    logABug(bugTitle, bugProject, fieldComment, fieldTags, repositoryName, useStoryboard);
    var currentSourceFile = "admin/objectstorage-ringbuilder";
    var pdfFileName = "doc-swift.pdf";
    pdfLink(currentSourceFile, pdfFileName);
</script>


  </body>
</html>