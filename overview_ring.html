
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>The Rings &#8212; Swift 0.1.0.dev10164 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/css/basic.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/sphinx_highlight.js"></script>
    <link rel="canonical" href="/openstack-swift/overview_ring.html" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Storage Policies" href="overview_policies.html" />
    <link rel="prev" title="Swift Architectural Overview" href="overview_architecture.html" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- Bootstrap CSS -->
<link href="_static/css/bootstrap.min.css" rel="stylesheet">

<!-- Fonts -->
<link href="_static/css/font-awesome.min.css" rel="stylesheet">

<!-- Custom CSS -->
<link href="_static/css/combined.css" rel="stylesheet">

<!-- Search CSS -->
<link href="_static/css/search.css" rel="stylesheet">

<!-- Pygments CSS -->
<link href="_static/pygments.css" rel="stylesheet">

<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

<!-- Google Analytics -->
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-17511903-1', 'auto');
ga('send', 'pageview');
</script>
<!-- End Google Analytics -->


  </head><body>

<!-- SOURCE_FILE: https://opendev.org/openstack/swift/src/doc/source/overview_ring.rst -->

<script>
    (function (window, document) {
        var loader = function () {
            var script = document.createElement("script"), tag = document.getElementsByTagName("script")[0];
            script.src = "https://search.openstack.org/widget/embed.min.js?t="+Date.now();
            tag.parentNode.insertBefore(script, tag);
        };
        window.addEventListener ? window.addEventListener("load", loader, false) : window.attachEvent("onload", loader);
    })(window, document);
</script>

<nav class="navbar navbar-default" role="navigation">
  <div class="container">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button class="navbar-toggle" data-target="#bs-example-navbar-collapse-1" data-toggle="collapse" type="button">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <div class="brand-wrapper">
        <a class="navbar-brand" href="https://www.openstack.org/"></a>
      </div>
      <div class="search-icon show"><i class="fa fa-search"></i> Search</div></div>
      <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <div class="search-container tiny">
    <div class="openstack-search-bar" data-baseUrl="search.openstack.org" data-context="docs-openstack"></div>
</div>
      <ul class="nav navbar-nav navbar-main show">
        <li class="search-container-mobile">
    <div class="openstack-search-bar" data-baseUrl="search.openstack.org" data-context="docs-openstack"></div>
</li>
        <li> <!--Software -->
          <a href="https://www.openstack.org/software/" class="drop" id="dropdownMenuSoftware">Software <i class="fa fa-caret-down"></i></a>
          <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenuSoftware">
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/software/">Overview</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/software/project-navigator/openstack-components">OpenStack Components</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/software/project-navigator/sdks">SDKs</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/software/project-navigator/deployment-tools">Deployment Tools</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/assets/software/projectmap/openstack-map.pdf" target="_blank">OpenStack Map</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/software/sample-configs/">Sample Configs</a></li>
          </ul>
        </li>
        <li> <!-- Use Cases -->
          <a href="https://www.openstack.org/use-cases/" class="drop" id="dropdownMenuUsers">Use Cases <i class="fa fa-caret-down"></i></a>
          <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenuUsers">
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/use-cases/">Users in Production</a></li>
            <li role="presentation" class="divider"></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/use-cases/bare-metal/">Ironic Bare Metal</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/use-cases/edge-computing/">Edge Computing</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/use-cases/telecoms-and-nfv/">Telecom & NFV</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/use-cases/science/">Science and HPC</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/use-cases/containers/">Containers</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/use-cases/enterprise/">Enterprise</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/surveys/landing">User Survey</a></li>
          </ul>
        </li>
        <li> <!-- Events -->
          <a href="https://www.openstack.org/events/" class="drop" id="dropdownMenuEvents">Events <i class="fa fa-caret-down"></i></a>
          <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenuEvents">
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/summit/">Open Infrastructure Summits</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/ptg/">Project Teams Gathering</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/events/opendev-2020/">OpenDev</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/events/community-events/">Community Events</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/events/openstackdays">OpenStack & OpenInfra Days</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/videos/">Summit Videos</a></li>
          </ul>
        </li>
        <li><!-- Community -->
          <a href="https://www.openstack.org/community/" class="drop" id="dropdownMenuCommunity">Community <i class="fa fa-caret-down"></i></a>
          <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenuCommunity">
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/community/">Welcome! Start Here</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/community/tech-committee">OpenStack Technical Committee</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/community/speakers/">Speakers Bureau</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://wiki.openstack.org">OpenStack Wiki</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/coa/">Get Certified (COA)</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/community/jobs/">Jobs</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/marketing/">Marketing Resources</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/news/">Community News</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://superuser.openstack.org">Superuser Magazine</a></li>
            <li role="presentation" class="divider"></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/community/supporting-organizations/">OpenInfra Foundation Supporting Organizations</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://openinfra.dev">Open Infrastructure Foundation (OpenInfra Foundation)</a></li>
          </ul>
        </li>
        <li><!-- Marketplace -->
          <a href="https://www.openstack.orgmarketplace/" class="drop" id="dropdownMenuLearn">Marketplace <i class="fa fa-caret-down"></i></a>
          <ul class="dropdown-menu dropdown-hover" role="menu" aria-labelledby="dropdownMenuEvents">
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/marketplace/training/">Training</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/marketplace/distros/">Distros & Appliances</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/marketplace/public-clouds/">Public Clouds</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/marketplace/hosted-private-clouds/">Hosted Private Clouds</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/marketplace/remotely-managed-private-clouds/">Remotely Managed Private Clouds</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/marketplace/consulting/">Consulting & Integrators</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/marketplace/drivers/">Drivers</a></li>
          </ul>
        </li>
        <li><!-- Blog -->
          <a href="https://www.openstack.org/blog/">Blog</a>
        </li>
        <li><!-- Docs -->
          <a href="http://docs.openstack.org/">Docs</a>
        </li>
        <li> <!-- Join -->
            <li class="join-nav-section">
              <a href="https://openinfra.dev/join/" id="dropdownMenuJoin">Join <i class="fa fa-caret-down"></i></a>
              <ul class="dropdown-menu dropdown-hover" role="menu" aria-labelledby="dropdownMenuJoin" style="display: none;">
                <li role="presentation"><a role="menuitem" tabindex="-1" href="https://openinfra.dev/join/">Sign up for Foundation Membership</a></li>
                <li role="presentation"><a role="menuitem" tabindex="-1" href="https://openinfra.dev/join/">Sponsor the Foundation</a></li>
                <li role="presentation"><a role="menuitem" tabindex="-1" href="https://openinfra.dev">More about the Foundation</a></li>
              </ul>
            </li>
            <li>
              <a href="https://www.openstack.org/Security/login/?BackURL=/home/" class="sign-in-btn">Log In</a>
            </li>
        </li>
      </ul>
    </div>
  </div>
  <!-- /.container -->
</nav>

    <div class="container docs-book-wrapper">
      <div class="row">
        <div class="col-lg-9 col-md-8 col-sm-8 col-lg-push-3 col-md-push-4 col-sm-push-4">
<div class="row docs-title">
  <div class="col-lg-8">
      <h1>The Rings</h1>
    
  </div>
  <div class="docs-actions">
    
    <a href="overview_architecture.html"><i class="fa fa-angle-double-left" data-toggle="tooltip" data-placement="top" title="Previous: Swift Architectural Overview"></i></a>
    
    
    <a href="overview_policies.html"><i class="fa fa-angle-double-right" data-toggle="tooltip" data-placement="top" title="Next: Storage Policies"></i></a>
    
    <a id="pdfLink1" href="" target="_blank" title="Download the manuals as PDF"><i class="fa fa-file-pdf-o" data-toggle="tooltip" data-placement="top" title="Download PDF"></i></a>
    
    <a id="logABugLink1" href="" target="_blank" title="Found an error? Report a bug against this page"><i class="fa fa-bug" data-toggle="tooltip" data-placement="top" title="Report a Bug"></i></a>
    
  </div>
</div>
          <div class="row">
            <div class="col-lg-12">
              <div class="docs-body" role="main">

  <section id="the-rings">
<h1>The Rings<a class="headerlink" href="#the-rings" title="Permalink to this heading">¶</a></h1>
<p>The rings determine where data should reside in the cluster. There is a
separate ring for account databases, container databases, and individual
object storage policies but each ring works in the same way. These rings are
externally managed. The server processes themselves do not modify the
rings; they are instead given new rings modified by other tools.</p>
<p>The ring uses a configurable number of bits from the MD5 hash of an item’s path
as a partition index that designates the device(s) on which that item should
be stored. The number of bits kept from the hash is known as the partition
power, and 2 to the partition power indicates the partition count. Partitioning
the full MD5 hash ring allows the cluster components to process resources in
batches. This ends up either more efficient or at least less complex than
working with each item separately or the entire cluster all at once.</p>
<p>Another configurable value is the replica count, which indicates how many
devices to assign for each partition in the ring. By having multiple devices
responsible for each partition, the cluster can recover from drive or network
failures.</p>
<p>Devices are added to the ring to describe the capacity available for
partition replica assignments.  Devices are placed into failure domains
consisting of region, zone, and server.  Regions can be used to describe
geographical systems characterized by lower bandwidth or higher latency between
machines in different regions.  Many rings will consist of only a single
region.  Zones can be used to group devices based on physical locations, power
separations, network separations, or any other attribute that would lessen
multiple replicas being unavailable at the same time.</p>
<p>Devices are given a weight which describes the relative storage capacity
contributed by the device in comparison to other devices.</p>
<p>When building a ring, replicas for each partition will be assigned to devices
according to the devices’ weights.  Additionally, each replica of a partition
will preferentially be assigned to a device whose failure domain does not
already have a replica for that partition.  Only a single replica of a
partition may be assigned to each device - you must have at least as many
devices as replicas.</p>
<section id="ring-builder">
<span id="id1"></span><h2>Ring Builder<a class="headerlink" href="#ring-builder" title="Permalink to this heading">¶</a></h2>
<p>The rings are built and managed manually by a utility called the ring-builder.
The ring-builder assigns partitions to devices and writes an optimized
structure to a gzipped, serialized file on disk for shipping out to the
servers. The server processes check the modification time of the file
occasionally and reload their in-memory copies of the ring structure as needed.
Because of how the ring-builder manages changes to the ring, using a slightly
older ring usually just means that for a subset of the partitions the device
for one of the replicas  will be incorrect, which can be easily worked around.</p>
<p>The ring-builder also keeps a separate builder file which includes the ring
information as well as additional data required to build future rings. It is
very important to keep multiple backup copies of these builder files. One
option is to copy the builder files out to every server while copying the ring
files themselves. Another is to upload the builder files into the cluster
itself. Complete loss of a builder file will mean creating a new ring from
scratch, nearly all partitions will end up assigned to different devices, and
therefore nearly all data stored will have to be replicated to new locations.
So, recovery from a builder file loss is possible, but data will definitely be
unreachable for an extended time.</p>
</section>
<section id="ring-data-structure">
<h2>Ring Data Structure<a class="headerlink" href="#ring-data-structure" title="Permalink to this heading">¶</a></h2>
<p>The ring data structure consists of three top level fields: a list of devices
in the cluster, a list of lists of device ids indicating partition to device
assignments, and an integer indicating the number of bits to shift an MD5 hash
to calculate the partition for the hash.</p>
<section id="list-of-devices">
<h3>List of Devices<a class="headerlink" href="#list-of-devices" title="Permalink to this heading">¶</a></h3>
<p>The list of devices is known internally to the Ring class as <code class="docutils literal notranslate"><span class="pre">devs</span></code>. Each
item in the list of devices is a dictionary with the following keys:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 10.0%" />
<col style="width: 80.0%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p>id</p></td>
<td><p>integer</p></td>
<td><p>The index into the list of devices.</p></td>
</tr>
<tr class="row-even"><td><p>zone</p></td>
<td><p>integer</p></td>
<td><p>The zone in which the device resides.</p></td>
</tr>
<tr class="row-odd"><td><p>region</p></td>
<td><p>integer</p></td>
<td><p>The region in which the zone resides.</p></td>
</tr>
<tr class="row-even"><td><p>weight</p></td>
<td><p>float</p></td>
<td><p>The relative weight of the device in comparison to other
devices. This usually corresponds directly to the amount of
disk space the device has compared to other devices. For
instance a device with 1 terabyte of space might have a weight
of 100.0 and another device with 2 terabytes of space might
have a weight of 200.0. This weight can also be used to bring
back into balance a device that has ended up with more or less
data than desired over time. A good average weight of 100.0
allows flexibility in lowering the weight later if necessary.</p></td>
</tr>
<tr class="row-odd"><td><p>ip</p></td>
<td><p>string</p></td>
<td><p>The IP address or hostname of the server containing the device.</p></td>
</tr>
<tr class="row-even"><td><p>port</p></td>
<td><p>int</p></td>
<td><p>The TCP port on which the server process listens to serve
requests for the device.</p></td>
</tr>
<tr class="row-odd"><td><p>device</p></td>
<td><p>string</p></td>
<td><p>The on-disk name of the device on the server.
For example: <code class="docutils literal notranslate"><span class="pre">sdb1</span></code></p></td>
</tr>
<tr class="row-even"><td><p>meta</p></td>
<td><p>string</p></td>
<td><p>A general-use field for storing additional information for the
device. This information isn’t used directly by the server
processes, but can be useful in debugging. For example, the
date and time of installation and hardware manufacturer could
be stored here.</p></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The list of devices may contain holes, or indexes set to <code class="docutils literal notranslate"><span class="pre">None</span></code>, for
devices that have been removed from the cluster. However, device ids are
reused. Device ids are reused to avoid potentially running out of device id
slots when there are available slots (from prior removal of devices). A
consequence of this device id reuse is that the device id (integer value)
does not necessarily correspond with the chronology of when the device was
added to the ring. Also, some devices may be temporarily disabled by
setting their weight to <code class="docutils literal notranslate"><span class="pre">0.0</span></code>. To obtain a list of active devices (for
uptime polling, for example) the Python code would look like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">devices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_iter_devs</span><span class="p">())</span>
</pre></div>
</div>
</div>
</section>
<section id="partition-assignment-list">
<h3>Partition Assignment List<a class="headerlink" href="#partition-assignment-list" title="Permalink to this heading">¶</a></h3>
<p>The partition assignment list is known internally to the Ring class as
<code class="docutils literal notranslate"><span class="pre">_replica2part2dev_id</span></code>. This is a list of <code class="docutils literal notranslate"><span class="pre">array('H')</span></code>s, one for each
replica. Each <code class="docutils literal notranslate"><span class="pre">array('H')</span></code> has a length equal to the partition count for the
ring. Each integer in the <code class="docutils literal notranslate"><span class="pre">array('H')</span></code> is an index into the above list of
devices.</p>
<p>So, to create a list of device dictionaries assigned to a partition, the Python
code would look like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">devices</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">devs</span><span class="p">[</span><span class="n">part2dev_id</span><span class="p">[</span><span class="n">partition</span><span class="p">]]</span>
           <span class="k">for</span> <span class="n">part2dev_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_replica2part2dev_id</span><span class="p">]</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">array('H')</span></code> is used for memory conservation as there may be millions of
partitions.</p>
</section>
<section id="partition-shift-value">
<h3>Partition Shift Value<a class="headerlink" href="#partition-shift-value" title="Permalink to this heading">¶</a></h3>
<p>The partition shift value is known internally to the Ring class as
<code class="docutils literal notranslate"><span class="pre">_part_shift</span></code>. This value is used to shift an MD5 hash of an item’s path to
calculate the partition on which the data for that item should reside. Only the
top four bytes of the hash are used in this process. For example, to compute
the partition for the path <code class="docutils literal notranslate"><span class="pre">/account/container/object</span></code>, the Python code might
look like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">objhash</span> <span class="o">=</span> <span class="n">md5</span><span class="p">(</span><span class="s1">&#39;/account/container/object&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
<span class="n">partition</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack_from</span><span class="p">(</span><span class="s1">&#39;&gt;I&#39;</span><span class="p">,</span> <span class="n">objhash</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_part_shift</span>
</pre></div>
</div>
<p>For a ring generated with partition power <code class="docutils literal notranslate"><span class="pre">P</span></code>, the partition shift value is
<code class="docutils literal notranslate"><span class="pre">32</span> <span class="pre">-</span> <span class="pre">P</span></code>.</p>
</section>
<section id="fractional-replicas">
<h3>Fractional Replicas<a class="headerlink" href="#fractional-replicas" title="Permalink to this heading">¶</a></h3>
<p>A ring is not restricted to having an integer number of replicas. In order to
support the gradual changing of replica counts, the ring is able to have a real
number of replicas.</p>
<p>When the number of replicas is not an integer, the last element of
<code class="docutils literal notranslate"><span class="pre">_replica2part2dev_id</span></code> will have a length that is less than the partition
count for the ring. This means that some partitions will have more replicas
than others. For example, if a ring has <code class="docutils literal notranslate"><span class="pre">3.25</span></code> replicas, then 25% of its
partitions will have four replicas, while the remaining 75% will have just
three.</p>
</section>
<section id="dispersion">
<span id="ring-dispersion"></span><h3>Dispersion<a class="headerlink" href="#dispersion" title="Permalink to this heading">¶</a></h3>
<p>With each rebalance, the ring builder calculates a dispersion metric. This is
the percentage of partitions in the ring that have too many replicas within a
particular failure domain.</p>
<p>For example, if you have three servers in a cluster but two replicas for a
partition get placed onto the same server, that partition will count towards
the dispersion metric.</p>
<p>A lower dispersion value is better, and the value can be used to find the
proper value for “overload”.</p>
</section>
<section id="overload">
<span id="ring-overload"></span><h3>Overload<a class="headerlink" href="#overload" title="Permalink to this heading">¶</a></h3>
<p>The ring builder tries to keep replicas as far apart as possible while
still respecting device weights. When it can’t do both, the overload
factor determines what happens. Each device may take some extra
fraction of its desired partitions to allow for replica dispersion;
once that extra fraction is exhausted, replicas will be placed closer
together than is optimal for durability.</p>
<p>Essentially, the overload factor lets the operator trade off replica
dispersion (durability) against device balance (uniform disk usage).</p>
<p>The default overload factor is <code class="docutils literal notranslate"><span class="pre">0</span></code>, so device weights will be strictly
followed.</p>
<p>With an overload factor of <code class="docutils literal notranslate"><span class="pre">0.1</span></code>, each device will accept 10% more
partitions than it otherwise would, but only if needed to maintain
dispersion.</p>
<p>Example: Consider a 3-node cluster of machines with equal-size disks;
let node A have 12 disks, node B have 12 disks, and node C have only
11 disks. Let the ring have an overload factor of <code class="docutils literal notranslate"><span class="pre">0.1</span></code> (10%).</p>
<p>Without the overload, some partitions would end up with replicas only
on nodes A and B. However, with the overload, every device is willing
to accept up to 10% more partitions for the sake of dispersion. The
missing disk in C means there is one disk’s worth of partitions that
would like to spread across the remaining 11 disks, which gives each
disk in C an extra 9.09% load. Since this is less than the 10%
overload, there is one replica of each partition on each node.</p>
<p>However, this does mean that the disks in node C will have more data
on them than the disks in nodes A and B. If 80% full is the warning
threshold for the cluster, node C’s disks will reach 80% full while A
and B’s disks are only 72.7% full.</p>
</section>
</section>
<section id="partition-replica-terminology">
<h2>Partition &amp; Replica Terminology<a class="headerlink" href="#partition-replica-terminology" title="Permalink to this heading">¶</a></h2>
<p>All descriptions of consistent hashing describe the process of breaking the
keyspace up into multiple ranges (vnodes, buckets, etc.) - many more than the
number of “nodes” to which keys in the keyspace must be assigned.  Swift calls
these ranges <cite>partitions</cite> - they are partitions of the total keyspace.</p>
<p>Each partition will have multiple replicas.  Every replica of each partition
must be assigned to a device in the ring.  When describing a specific replica
of a partition (like when it’s assigned a device) it is described as a
<cite>part-replica</cite> in that it is a specific <cite>replica</cite> of the specific <cite>partition</cite>.
A single device will likely be assigned different replicas from many
partitions, but it may not be assigned multiple replicas of a single partition.</p>
<p>The total number of partitions in a ring is calculated as <code class="docutils literal notranslate"><span class="pre">2</span> <span class="pre">**</span>
<span class="pre">&lt;part-power&gt;</span></code>.  The total number of part-replicas in a ring is calculated as
<code class="docutils literal notranslate"><span class="pre">&lt;replica-count&gt;</span> <span class="pre">*</span> <span class="pre">2</span> <span class="pre">**</span> <span class="pre">&lt;part-power&gt;</span></code>.</p>
<p>When considering a device’s <cite>weight</cite> it is useful to describe the number of
part-replicas it would like to be assigned.  A single device, regardless of
weight, will never hold more than <code class="docutils literal notranslate"><span class="pre">2</span> <span class="pre">**</span> <span class="pre">&lt;part-power&gt;</span></code> part-replicas because
it can not have more than one replica of any partition assigned.  The number of
part-replicas a device can take by weights is calculated as its <cite>parts-wanted</cite>.
The true number of part-replicas assigned to a device can be compared to its
parts-wanted similarly to a calculation of percentage error - this deviation in
the observed result from the idealized target is called a device’s <cite>balance</cite>.</p>
<p>When considering a device’s <cite>failure domain</cite> it is useful to describe the number
of part-replicas it would like to be assigned.  The number of part-replicas
wanted in a failure domain of a tier is the sum of the part-replicas wanted in
the failure domains of its sub-tier.  However, collectively when the total
number of part-replicas in a failure domain exceeds or is equal to <code class="docutils literal notranslate"><span class="pre">2</span> <span class="pre">**</span>
<span class="pre">&lt;part-power&gt;</span></code> it is most obvious that it’s no longer sufficient to consider
only the number of total part-replicas, but rather the fraction of each
replica’s partitions.  Consider for example a ring with 3 replicas and 3
servers: while dispersion requires that each server hold only ⅓ of the total
part-replicas, placement is additionally constrained to require <code class="docutils literal notranslate"><span class="pre">1.0</span></code> replica
of <em>each</em> partition per server.  It would not be sufficient to satisfy
dispersion if two devices on one of the servers each held a replica of a single
partition, while another server held none.  By considering a decimal fraction
of one replica’s worth of partitions in a failure domain we can derive the
total part-replicas wanted in a failure domain (<code class="docutils literal notranslate"><span class="pre">1.0</span> <span class="pre">*</span> <span class="pre">2</span> <span class="pre">**</span> <span class="pre">&lt;part-power&gt;</span></code>).
Additionally we infer more about <cite>which</cite> part-replicas must go in the failure
domain.  Consider a ring with three replicas and two zones, each with two
servers (four servers total). The three replicas worth of partitions will be
assigned into two failure domains at the zone tier.  Each zone must hold more
than one replica of some partitions.  We represent this improper fraction of a
replica’s worth of partitions in decimal form as <code class="docutils literal notranslate"><span class="pre">1.5</span></code> (<code class="docutils literal notranslate"><span class="pre">3.0</span> <span class="pre">/</span> <span class="pre">2</span></code>).  This
tells us not only the <em>number</em> of total partitions (<code class="docutils literal notranslate"><span class="pre">1.5</span> <span class="pre">*</span> <span class="pre">2</span> <span class="pre">**</span>
<span class="pre">&lt;part-power&gt;</span></code>) but also that <em>each</em> partition must have <cite>at least</cite> one replica
in this failure domain (in fact <code class="docutils literal notranslate"><span class="pre">0.5</span></code> of the partitions will have 2
replicas).  Within each zone the two servers will hold <code class="docutils literal notranslate"><span class="pre">0.75</span></code> of a replica’s
worth of partitions - this is equal both to “the fraction of a replica’s worth
of partitions assigned to each zone (<code class="docutils literal notranslate"><span class="pre">1.5</span></code>) divided evenly among the number
of failure domains in its sub-tier (2 servers in each zone, i.e.  <code class="docutils literal notranslate"><span class="pre">1.5</span> <span class="pre">/</span> <span class="pre">2</span></code>)”
but <em>also</em> “the total number of replicas (<code class="docutils literal notranslate"><span class="pre">3.0</span></code>) divided evenly among the
total number of failure domains in the server tier (2 servers × 2 zones = 4,
i.e.  <code class="docutils literal notranslate"><span class="pre">3.0</span> <span class="pre">/</span> <span class="pre">4</span></code>)”. It is useful to consider that each server in this ring
will hold only <code class="docutils literal notranslate"><span class="pre">0.75</span></code> of a replica’s worth of partitions which tells that any
server should have <cite>at most</cite> one replica of a given partition assigned.  In the
interests of brevity, some variable names will often refer to the concept
representing the fraction of a replica’s worth of partitions in decimal form as
<em>replicanths</em> - this is meant to invoke connotations similar to ordinal numbers
as applied to fractions, but generalized to a replica instead of a four*th* or
a fif*th*.  The “n” was probably thrown in because of Blade Runner.</p>
</section>
<section id="building-the-ring">
<h2>Building the Ring<a class="headerlink" href="#building-the-ring" title="Permalink to this heading">¶</a></h2>
<p>First the ring builder calculates the replicanths wanted at each tier in the
ring’s topology based on weight.</p>
<p>Then the ring builder calculates the replicanths wanted at each tier in the
ring’s topology based on dispersion.</p>
<p>Then the ring builder calculates the maximum deviation on a single device
between its weighted replicanths and wanted replicanths.</p>
<p>Next we interpolate between the two replicanth values (weighted &amp; wanted) at
each tier using the specified overload (up to the maximum required overload).
It’s a linear interpolation, similar to solving for a point on a line between
two points - we calculate the slope across the max required overload and then
calculate the intersection of the line with the desired overload.  This
becomes the target.</p>
<p>From the target we calculate the minimum and maximum number of replicas any
partition may have in a tier.  This becomes the <cite>replica-plan</cite>.</p>
<p>Finally, we calculate the number of partitions that should ideally be assigned
to each device based the replica-plan.</p>
<p>On initial balance (i.e., the first time partitions are placed to generate a
ring) we must assign each replica of each partition to the device that desires
the most partitions excluding any devices that already have their maximum
number of replicas of that partition assigned to some parent tier of that
device’s failure domain.</p>
<p>When building a new ring based on an old ring, the desired number of
partitions each device wants is recalculated from the current replica-plan.
Next the partitions to be reassigned are gathered up. Any removed devices have
all their assigned partitions unassigned and added to the gathered list. Any
partition replicas that (due to the addition of new devices) can be spread out
for better durability are unassigned and added to the gathered list. Any
devices that have more partitions than they now desire have random partitions
unassigned from them and added to the gathered list. Lastly, the gathered
partitions are then reassigned to devices using a similar method as in the
initial assignment described above.</p>
<p>Whenever a partition has a replica reassigned, the time of the reassignment is
recorded. This is taken into account when gathering partitions to reassign so
that no partition is moved twice in a configurable amount of time. This
configurable amount of time is known internally to the RingBuilder class as
<code class="docutils literal notranslate"><span class="pre">min_part_hours</span></code>. This restriction is ignored for replicas of partitions on
devices that have been removed, as device removal should only happens on device
failure and there’s no choice but to make a reassignment.</p>
<p>The above processes don’t always perfectly rebalance a ring due to the random
nature of gathering partitions for reassignment. To help reach a more balanced
ring, the rebalance process is repeated a fixed number of times until the
replica-plan is fulfilled or unable to be fulfilled (indicating we probably
can’t get perfect balance due to too many partitions recently moved).</p>
</section>
<section id="composite-rings">
<span id="id2"></span><h2>Composite Rings<a class="headerlink" href="#composite-rings" title="Permalink to this heading">¶</a></h2>
<p>See <a class="reference internal" href="ring.html#composite-builder"><span class="std std-ref">Composite Ring Builder</span></a>.</p>
<section id="module-swift.cli.ringcomposer">
<span id="swift-ring-composer-experimental"></span><h3>swift-ring-composer (Experimental)<a class="headerlink" href="#module-swift.cli.ringcomposer" title="Permalink to this heading">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">swift-ring-composer</span></code> is an experimental tool for building a composite ring
file from other existing component ring builder files. Its CLI, name or
implementation may change or be removed altogether in future versions of Swift.</p>
<p>Currently its interface is similar to that of the <code class="docutils literal notranslate"><span class="pre">swift-ring-builder</span></code>. The
command structure takes the form of:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">swift</span><span class="o">-</span><span class="n">ring</span><span class="o">-</span><span class="n">composer</span> <span class="o">&lt;</span><span class="n">composite</span> <span class="n">builder</span> <span class="n">file</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">sub</span><span class="o">-</span><span class="n">command</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">options</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">&lt;composite</span> <span class="pre">builder</span> <span class="pre">file&gt;</span></code> is a special builder which stores a json
blob of composite ring metadata. This metadata describes the component
<code class="docutils literal notranslate"><span class="pre">RingBuilder</span></code>’s used in the composite ring, their order and version.</p>
<p>There are currently 2 sub-commands: <code class="docutils literal notranslate"><span class="pre">show</span></code> and <code class="docutils literal notranslate"><span class="pre">compose</span></code>. The <code class="docutils literal notranslate"><span class="pre">show</span></code>
sub-command takes no additional arguments and displays the current contents of
of the composite builder file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">swift</span><span class="o">-</span><span class="n">ring</span><span class="o">-</span><span class="n">composer</span> <span class="o">&lt;</span><span class="n">composite</span> <span class="n">builder</span> <span class="n">file</span><span class="o">&gt;</span> <span class="n">show</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">compose</span></code> sub-command is the one that actually stitches the component
ring builders together to create both the composite ring file and composite
builder file. The command takes the form:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">swift</span><span class="o">-</span><span class="n">ring</span><span class="o">-</span><span class="n">composer</span> <span class="o">&lt;</span><span class="n">composite</span> <span class="n">builder</span> <span class="n">file</span><span class="o">&gt;</span> <span class="n">compose</span> <span class="o">&lt;</span><span class="n">builder1</span><span class="o">&gt;</span> \
<span class="o">&lt;</span><span class="n">builder2</span><span class="o">&gt;</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">builder3</span><span class="o">&gt;</span> <span class="o">..</span> <span class="o">&lt;</span><span class="n">builderN</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">--</span><span class="n">output</span> <span class="o">&lt;</span><span class="n">composite</span> <span class="n">ring</span> <span class="n">file</span><span class="o">&gt;</span> \
<span class="p">[</span><span class="o">--</span><span class="n">force</span><span class="p">]</span>
</pre></div>
</div>
<p>There may look like there is a lot going on there but it’s actually quite
simple. The <code class="docutils literal notranslate"><span class="pre">compose</span></code> command takes in the list of builders to stitch
together and the filename for the composite ring file via the <code class="docutils literal notranslate"><span class="pre">--output</span></code>
option. The <code class="docutils literal notranslate"><span class="pre">--force</span></code> option overrides checks on the ring composition.</p>
<p>To change ring devices, first add or remove devices from the component ring
builders and then use the <code class="docutils literal notranslate"><span class="pre">compose</span></code> sub-command to create a new composite
ring file.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">swift-ring-builder</span></code> cannot be used to inspect the generated composite
ring file because there is no conventional builder file corresponding to
the composite ring file name. You can either programmatically look inside
the composite ring file using the swift ring classes or create a temporary
builder file from the composite ring file using:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">swift</span><span class="o">-</span><span class="n">ring</span><span class="o">-</span><span class="n">builder</span> <span class="o">&lt;</span><span class="n">composite</span> <span class="n">ring</span> <span class="n">file</span><span class="o">&gt;</span> <span class="n">write_builder</span>
</pre></div>
</div>
<p>Do not use this builder file to manage ring devices.</p>
</div>
<p>For further details use:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">swift</span><span class="o">-</span><span class="n">ring</span><span class="o">-</span><span class="n">composer</span> <span class="o">-</span><span class="n">h</span>
</pre></div>
</div>
</section>
</section>
<section id="module-swift.cli.ring_builder_analyzer">
<span id="ring-builder-analyzer"></span><h2>Ring Builder Analyzer<a class="headerlink" href="#module-swift.cli.ring_builder_analyzer" title="Permalink to this heading">¶</a></h2>
<p>This is a tool for analyzing how well the ring builder performs its job
in a particular scenario. It is intended to help developers quantify any
improvements or regressions in the ring builder; it is probably not useful
to others.</p>
<p>The ring builder analyzer takes a scenario file containing some initial
parameters for a ring builder plus a certain number of rounds. In each
round, some modifications are made to the builder, e.g. add a device, remove
a device, change a device’s weight. Then, the builder is repeatedly
rebalanced until it settles down. Data about that round is printed, and the
next round begins.</p>
<p>Scenarios are specified in JSON. Example scenario for a gradual device
addition:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;part_power&quot;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
    <span class="s2">&quot;replicas&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s2">&quot;overload&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="s2">&quot;random_seed&quot;</span><span class="p">:</span> <span class="mi">203488</span><span class="p">,</span>

    <span class="s2">&quot;rounds&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">[</span>
            <span class="p">[</span><span class="s2">&quot;add&quot;</span><span class="p">,</span> <span class="s2">&quot;r1z2-10.20.30.40:6200/sda&quot;</span><span class="p">,</span> <span class="mi">8000</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;add&quot;</span><span class="p">,</span> <span class="s2">&quot;r1z2-10.20.30.40:6200/sdb&quot;</span><span class="p">,</span> <span class="mi">8000</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;add&quot;</span><span class="p">,</span> <span class="s2">&quot;r1z2-10.20.30.40:6200/sdc&quot;</span><span class="p">,</span> <span class="mi">8000</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;add&quot;</span><span class="p">,</span> <span class="s2">&quot;r1z2-10.20.30.40:6200/sdd&quot;</span><span class="p">,</span> <span class="mi">8000</span><span class="p">],</span>

            <span class="p">[</span><span class="s2">&quot;add&quot;</span><span class="p">,</span> <span class="s2">&quot;r1z2-10.20.30.41:6200/sda&quot;</span><span class="p">,</span> <span class="mi">8000</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;add&quot;</span><span class="p">,</span> <span class="s2">&quot;r1z2-10.20.30.41:6200/sdb&quot;</span><span class="p">,</span> <span class="mi">8000</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;add&quot;</span><span class="p">,</span> <span class="s2">&quot;r1z2-10.20.30.41:6200/sdc&quot;</span><span class="p">,</span> <span class="mi">8000</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;add&quot;</span><span class="p">,</span> <span class="s2">&quot;r1z2-10.20.30.41:6200/sdd&quot;</span><span class="p">,</span> <span class="mi">8000</span><span class="p">],</span>

            <span class="p">[</span><span class="s2">&quot;add&quot;</span><span class="p">,</span> <span class="s2">&quot;r1z2-10.20.30.43:6200/sda&quot;</span><span class="p">,</span> <span class="mi">8000</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;add&quot;</span><span class="p">,</span> <span class="s2">&quot;r1z2-10.20.30.43:6200/sdb&quot;</span><span class="p">,</span> <span class="mi">8000</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;add&quot;</span><span class="p">,</span> <span class="s2">&quot;r1z2-10.20.30.43:6200/sdc&quot;</span><span class="p">,</span> <span class="mi">8000</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;add&quot;</span><span class="p">,</span> <span class="s2">&quot;r1z2-10.20.30.43:6200/sdd&quot;</span><span class="p">,</span> <span class="mi">8000</span><span class="p">],</span>

            <span class="p">[</span><span class="s2">&quot;add&quot;</span><span class="p">,</span> <span class="s2">&quot;r1z2-10.20.30.44:6200/sda&quot;</span><span class="p">,</span> <span class="mi">8000</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;add&quot;</span><span class="p">,</span> <span class="s2">&quot;r1z2-10.20.30.44:6200/sdb&quot;</span><span class="p">,</span> <span class="mi">8000</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;add&quot;</span><span class="p">,</span> <span class="s2">&quot;r1z2-10.20.30.44:6200/sdc&quot;</span><span class="p">,</span> <span class="mi">8000</span><span class="p">]</span>
        <span class="p">],</span> <span class="p">[</span>
            <span class="p">[</span><span class="s2">&quot;add&quot;</span><span class="p">,</span> <span class="s2">&quot;r1z2-10.20.30.44:6200/sdd&quot;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">]</span>
        <span class="p">],</span> <span class="p">[</span>
            <span class="p">[</span><span class="s2">&quot;set_weight&quot;</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">2000</span><span class="p">]</span>
        <span class="p">],</span> <span class="p">[</span>
            <span class="p">[</span><span class="s2">&quot;remove&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;set_weight&quot;</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">3000</span><span class="p">]</span>
        <span class="p">],</span> <span class="p">[</span>
            <span class="p">[</span><span class="s2">&quot;set_weight&quot;</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">4000</span><span class="p">]</span>
        <span class="p">],</span> <span class="p">[</span>
            <span class="p">[</span><span class="s2">&quot;set_weight&quot;</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">5000</span><span class="p">]</span>
        <span class="p">],</span> <span class="p">[</span>
            <span class="p">[</span><span class="s2">&quot;set_weight&quot;</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">6000</span><span class="p">]</span>
        <span class="p">],</span> <span class="p">[</span>
            <span class="p">[</span><span class="s2">&quot;set_weight&quot;</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">7000</span><span class="p">]</span>
        <span class="p">],</span> <span class="p">[</span>
            <span class="p">[</span><span class="s2">&quot;set_weight&quot;</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">8000</span><span class="p">]</span>
        <span class="p">]]</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="history">
<h2>History<a class="headerlink" href="#history" title="Permalink to this heading">¶</a></h2>
<p>The ring code went through many iterations before arriving at what it is now
and while it has largely been stable, the algorithm has seen a few tweaks or
perhaps even fundamentally changed as new ideas emerge. This section will try
to describe the previous ideas attempted and attempt to explain why they were
discarded.</p>
<p>A “live ring” option was considered where each server could maintain its own
copy of the ring and the servers would use a gossip protocol to communicate the
changes they made. This was discarded as too complex and error prone to code
correctly in the project timespan available. One bug could easily gossip bad
data out to the entire cluster and be difficult to recover from. Having an
externally managed ring simplifies the process, allows full validation of data
before it’s shipped out to the servers, and guarantees each server is using a
ring from the same timeline. It also means that the servers themselves aren’t
spending a lot of resources maintaining rings.</p>
<p>A couple of “ring server” options were considered. One was where all ring
lookups would be done by calling a service on a separate server or set of
servers, but this was discarded due to the latency involved. Another was much
like the current process but where servers could submit change requests to the
ring server to have a new ring built and shipped back out to the servers. This
was discarded due to project time constraints and because ring changes are
currently infrequent enough that manual control was sufficient. However, lack
of quick automatic ring changes did mean that other components of the system
had to be coded to handle devices being unavailable for a period of hours until
someone could manually update the ring.</p>
<p>The current ring process has each replica of a partition independently assigned
to a device. A version of the ring that used a third of the memory was tried,
where the first replica of a partition was directly assigned and the other two
were determined by “walking” the ring until finding additional devices in other
zones. This was discarded due to the loss of control over how many replicas for
a given partition moved at once. Keeping each replica independent allows for
moving only one partition replica within a given time window (except due to
device failures). Using the additional memory was deemed a good trade-off for
moving data around the cluster much less often.</p>
<p>Another ring design was tried where the partition to device assignments weren’t
stored in a big list in memory but instead each device was assigned a set of
hashes, or anchors. The partition would be determined from the data item’s hash
and the nearest device anchors would determine where the replicas should be
stored. However, to get reasonable distribution of data each device had to have
a lot of anchors and walking through those anchors to find replicas started to
add up. In the end, the memory savings wasn’t that great and more processing
power was used, so the idea was discarded.</p>
<p>A completely non-partitioned ring was also tried but discarded as the
partitioning helps many other components of the system, especially replication.
Replication can be attempted and retried in a partition batch with the other
replicas rather than each data item independently attempted and retried. Hashes
of directory structures can be calculated and compared with other replicas to
reduce directory walking and network traffic.</p>
<p>Partitioning and independently assigning partition replicas also allowed for
the best-balanced cluster. The best of the other strategies tended to give
±10% variance on device balance with devices of equal weight and ±15% with
devices of varying weights. The current strategy allows us to get ±3% and ±8%
respectively.</p>
<p>Various hashing algorithms were tried. SHA offers better security, but the ring
doesn’t need to be cryptographically secure and SHA is slower. Murmur was much
faster, but MD5 was built-in and hash computation is a small percentage of the
overall request handling time. In all, once it was decided the servers wouldn’t
be maintaining the rings themselves anyway and only doing hash lookups, MD5 was
chosen for its general availability, good distribution, and adequate speed.</p>
<p>The placement algorithm has seen a number of behavioral changes for
unbalanceable rings. The ring builder wants to keep replicas as far apart as
possible while still respecting device weights. In most cases, the ring
builder can achieve both, but sometimes they conflict.  At first, the behavior
was to keep the replicas far apart and ignore device weight, but that made it
impossible to gradually go from one region to two, or from two to three. Then
it was changed to favor device weight over dispersion, but that wasn’t so good
for rings that were close to balanceable, like 3 machines with 60TB, 60TB, and
57TB of disk space; operators were expecting one replica per machine, but
didn’t always get it. After that, overload was added to the ring builder so
that operators could choose a balance between dispersion and device weights.
In time the overload concept was improved and made more accurate.</p>
<p>For more background on consistent hashing rings, please see
<a class="reference internal" href="ring_background.html"><span class="doc">Building a Consistent Hashing Ring</span></a>.</p>
</section>
</section>


              </div>
            </div>
          </div>
          <div class="docs-actions">
          
            <a href="overview_architecture.html"><i class="fa fa-angle-double-left" data-toggle="tooltip" data-placement="top" title="Previous: Swift Architectural Overview"></i></a>
          
          
            <a href="overview_policies.html"><i class="fa fa-angle-double-right" data-toggle="tooltip" data-placement="top" title="Next: Storage Policies"></i></a>
          
          <a id="pdfLink2" href="" target="_blank" title="Download the manuals as PDF"><i class="fa fa-file-pdf-o" data-toggle="tooltip" data-placement="top" title="Download PDF"></i></a>
          
            <a id="logABugLink3" href="" target="_blank" title="Found an error? Report a bug against this page"><i class="fa fa-bug" data-toggle="tooltip" data-placement="top" title="Report a Bug"></i></a>
          
          </div>
          <div class="row docs-byline bottom">
            <div class="docs-updated">this page last updated: 2019-09-04 14:30:33</div>
          </div>
          <div class="row">
            <div class="col-lg-8 col-md-8 col-sm-8 docs-license">
<a href="https://creativecommons.org/licenses/by/3.0/">
 <img src="_static/images/docs/license.png" alt="Creative Commons Attribution 3.0 License"/>
</a>
<p>
 Except where otherwise noted, this document is licensed under
 <a href="https://creativecommons.org/licenses/by/3.0/">Creative Commons
 Attribution 3.0 License</a>. See all <a href="https://www.openstack.org/legal">
 OpenStack Legal Documents</a>.
</p>
            </div>
            <div class="col-lg-4 col-md-4 col-sm-4 docs-actions-wrapper">
            <!-- ID buglinkbottom added so that pre-filled doc bugs
                 are sent to Launchpad projects related to the
                 document -->
              <a href="#" id="logABugLink2" class="docs-footer-actions"><i class="fa fa-bug"></i> found an error? report a bug</a>
            </div>
          </div>
        </div>
<div class="col-lg-3 col-md-4 col-sm-4 col-lg-pull-9 col-md-pull-8 col-sm-pull-8 docs-sidebar">
  <div class="btn-group docs-sidebar-releases">
    <button onclick="location.href='/'" class="btn docs-sidebar-home" data-toggle="tooltip" data-placement="top" title="OpenStack Docs Home"><i class="fa fa-arrow-circle-o-left"></i></button>
<button href="#" type="button" data-toggle="dropdown" class="btn docs-sidebar-release-select">OpenStack Documentation<i class="fa fa-caret-down"></i></button>
    <ul class="dropdown-menu docs-sidebar-dropdown" role="menu" aria-labelledby="dLabel">
      <li role="presentation" class="dropdown-header">Guides</li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="https://docs.openstack.org/index.html#install-guides">Install Guides</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="https://docs.openstack.org/index.html#user-guides">User Guides</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="https://docs.openstack.org/index.html#configuration-guides">Configuration Guides</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="https://docs.openstack.org/index.html#ops-and-admin-guides">Operations and Administration Guides</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="https://docs.openstack.org/index.html#api-guides">API Guides</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="https://docs.openstack.org/index.html#contributor-guides">Contributor Guides</a></li>
      <li role="presentation" class="dropdown-header">Languages</li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="https://docs.openstack.org/de/">Deutsch (German)</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="https://docs.openstack.org/fr/">Français (French)</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="https://docs.openstack.org/id/">Bahasa Indonesia (Indonesian)</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="https://docs.openstack.org/it/">Italiano (Italian)</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="https://docs.openstack.org/ja/">日本語 (Japanese)</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="https://docs.openstack.org/ko_KR/">한국어 (Korean)</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="https://docs.openstack.org/pt_BR/">Português (Portuguese)</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="https://docs.openstack.org/tr_TR/">Türkçe (Türkiye)</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="https://docs.openstack.org/zh_CN/">简体中文 (Simplified Chinese)</a></li>
    </ul>
  </div>
  <div class="docs-sidebar-toc">
    <div class="docs-sidebar-section" id="table-of-contents">
      <a href="index.html" class="docs-sidebar-section-title"><h4>Swift 0.1.0.dev10164</h4></a>
      <ul>
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">Getting Started</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="api/object_api_v1_overview.html">Object Storage API overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="overview_architecture.html">Swift Architectural Overview</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">The Rings</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#ring-builder">Ring Builder</a></li>
<li class="toctree-l2"><a class="reference internal" href="#ring-data-structure">Ring Data Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="#partition-replica-terminology">Partition &amp; Replica Terminology</a></li>
<li class="toctree-l2"><a class="reference internal" href="#building-the-ring">Building the Ring</a></li>
<li class="toctree-l2"><a class="reference internal" href="#composite-rings">Composite Rings</a></li>
<li class="toctree-l2"><a class="reference internal" href="#module-swift.cli.ring_builder_analyzer">Ring Builder Analyzer</a></li>
<li class="toctree-l2"><a class="reference internal" href="#history">History</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="overview_policies.html">Storage Policies</a></li>
<li class="toctree-l1"><a class="reference internal" href="overview_reaper.html">The Account Reaper</a></li>
<li class="toctree-l1"><a class="reference internal" href="overview_auth.html">The Auth System</a></li>
<li class="toctree-l1"><a class="reference internal" href="overview_acl.html">Access Control Lists (ACLs)</a></li>
<li class="toctree-l1"><a class="reference internal" href="overview_replication.html">Replication</a></li>
<li class="toctree-l1"><a class="reference internal" href="ratelimit.html">Rate Limiting</a></li>
<li class="toctree-l1"><a class="reference internal" href="overview_large_objects.html">Large Object Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="overview_global_cluster.html">Global Clusters</a></li>
<li class="toctree-l1"><a class="reference internal" href="overview_container_sync.html">Container to Container Synchronization</a></li>
<li class="toctree-l1"><a class="reference internal" href="overview_expiring_objects.html">Expiring Object Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="cors.html">CORS</a></li>
<li class="toctree-l1"><a class="reference internal" href="crossdomain.html">Cross-domain Policy File</a></li>
<li class="toctree-l1"><a class="reference internal" href="overview_erasure_code.html">Erasure Code Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="overview_encryption.html">Object Encryption</a></li>
<li class="toctree-l1"><a class="reference internal" href="overview_backing_store.html">Using Swift as Backing Store for Service Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="overview_container_sharding.html">Container Sharding</a></li>
<li class="toctree-l1"><a class="reference internal" href="ring_background.html">Building a Consistent Hashing Ring</a></li>
<li class="toctree-l1"><a class="reference internal" href="ring_partpower.html">Modifying Ring Partition Power</a></li>
<li class="toctree-l1"><a class="reference internal" href="associated_projects.html">Associated Projects</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="contributor/contributing.html">Contributing to OpenStack Swift</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributor/contributing.html#swift-design-principles">Swift Design Principles</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributor/contributing.html#recommended-workflow">Recommended workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributor/contributing.html#notes-on-testing">Notes on Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributor/contributing.html#ideas">Ideas</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributor/contributing.html#community">Community</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributor/review_guidelines.html">Review Guidelines</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="development_guidelines.html">Development Guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="development_saio.html">SAIO (Swift All In One)</a></li>
<li class="toctree-l1"><a class="reference internal" href="first_contribution_swift.html">First Contribution to Swift</a></li>
<li class="toctree-l1"><a class="reference internal" href="policies_saio.html">Adding Storage Policies to an Existing SAIO</a></li>
<li class="toctree-l1"><a class="reference internal" href="development_auth.html">Auth Server and Middleware</a></li>
<li class="toctree-l1"><a class="reference internal" href="development_middleware.html">Middleware and Metadata</a></li>
<li class="toctree-l1"><a class="reference internal" href="development_ondisk_backends.html">Pluggable On-Disk Back-end APIs</a></li>
<li class="toctree-l1"><a class="reference internal" href="development_watchers.html">Auditor Watchers</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="deployment_guide.html">Deployment Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="apache_deployment_guide.html">Apache Deployment Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="admin_guide.html">Administrator’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="replication_network.html">Dedicated replication network</a></li>
<li class="toctree-l1"><a class="reference internal" href="logs.html">Logs</a></li>
<li class="toctree-l1"><a class="reference internal" href="ops_runbook/index.html">Swift Ops Runbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="admin/index.html">OpenStack Swift Administrator Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="install/index.html">Object Storage Install Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="config/index.html">Configuration Documentation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="api/object_api_v1_overview.html">Object Storage API overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/discoverability.html">Discoverability</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/authentication.html">Authentication</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/container_quotas.html">Container quotas</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/object_versioning.html">Object versioning</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/large_objects.html">Large objects</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/temporary_url_middleware.html">Temporary URL middleware</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/form_post_middleware.html">Form POST middleware</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/use_content-encoding_metadata.html">Use Content-Encoding metadata</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/use_the_content-disposition_metadata.html">Use the Content-Disposition metadata</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/pseudo-hierarchical-folders-directories.html">Pseudo-hierarchical folders and directories</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/pagination.html">Page through large lists of containers or objects</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/serialized-response-formats.html">Serialized response formats</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/static-website.html">Create static website</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/object-expiration.html">Object expiration</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/bulk-delete.html">Bulk delete</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="s3_compat.html">S3/Swift REST API Comparison Matrix</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="ring.html">Partitioned Consistent Hash Ring</a></li>
<li class="toctree-l1"><a class="reference internal" href="proxy.html">Proxy</a></li>
<li class="toctree-l1"><a class="reference internal" href="account.html">Account</a></li>
<li class="toctree-l1"><a class="reference internal" href="container.html">Container</a></li>
<li class="toctree-l1"><a class="reference internal" href="db.html">Account DB and Container DB</a></li>
<li class="toctree-l1"><a class="reference internal" href="object.html">Object</a></li>
<li class="toctree-l1"><a class="reference internal" href="misc.html">Misc</a></li>
<li class="toctree-l1"><a class="reference internal" href="middleware.html">Middleware</a></li>
<li class="toctree-l1"><a class="reference internal" href="audit_watchers.html">Object Audit Watchers</a></li>
</ul>

    </div>

  <div class="docs-sidebar-toc">
    <div class="docs-sidebar-section" id="local-table-of-contents">
      <h4 class="docs-sidebar-section-title">Page Contents</h4>
      <ul>
<li><a class="reference internal" href="#">The Rings</a><ul>
<li><a class="reference internal" href="#ring-builder">Ring Builder</a></li>
<li><a class="reference internal" href="#ring-data-structure">Ring Data Structure</a><ul>
<li><a class="reference internal" href="#list-of-devices">List of Devices</a></li>
<li><a class="reference internal" href="#partition-assignment-list">Partition Assignment List</a></li>
<li><a class="reference internal" href="#partition-shift-value">Partition Shift Value</a></li>
<li><a class="reference internal" href="#fractional-replicas">Fractional Replicas</a></li>
<li><a class="reference internal" href="#dispersion">Dispersion</a></li>
<li><a class="reference internal" href="#overload">Overload</a></li>
</ul>
</li>
<li><a class="reference internal" href="#partition-replica-terminology">Partition &amp; Replica Terminology</a></li>
<li><a class="reference internal" href="#building-the-ring">Building the Ring</a></li>
<li><a class="reference internal" href="#composite-rings">Composite Rings</a><ul>
<li><a class="reference internal" href="#module-swift.cli.ringcomposer">swift-ring-composer (Experimental)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#module-swift.cli.ring_builder_analyzer">Ring Builder Analyzer</a></li>
<li><a class="reference internal" href="#history">History</a></li>
</ul>
</li>
</ul>

    </div>
  </div>
  </div>
</div>
      </div>
    </div>
<footer>
  <div class="container">
    <div class="row footer-links">
      <div class="col-lg-2 col-sm-2">
        <h3>OpenStack</h3>
        <ul>
          <li><a href="https://openstack.org/projects/">Projects</a></li>
          <li><a href="https://www.openstack.org/software/security/">OpenStack Security</a></li>
          <li><a href="https://openstack.org/projects/openstack-faq/">Common Questions</a></li>
          <li><a href="https://openstack.org/blog/">Blog</a></li>g
          <li><a href="https://openstack.org/news/">News</a></li>
        </ul>
      </div>
      <div class="col-lg-2 col-sm-2">
        <h3>Community</h3>
        <ul>
          <li><a href="https://openstack.org/community/">User Groups</a></li>
          <li><a href="https://openstack.org/community/events/">Events</a></li>
          <li><a href="https://openstack.org/community/jobs/">Jobs</a></li>
          <li><a href="https://openstack.org/foundation/companies/">Companies</a></li>
          <li><a href="https://docs.openstack.org/contributors">Contribute</a></li>
        </ul>
      </div>
      <div class="col-lg-2 col-sm-2">
        <h3>Documentation</h3>
        <ul>
          <li><a href="https://docs.openstack.org">OpenStack Manuals</a></li>
          <li><a href="https://openstack.org/software/start/">Getting Started</a></li>
          <li><a href="https://developer.openstack.org">API Documentation</a></li>
          <li><a href="https://wiki.openstack.org">Wiki</a></li>
        </ul>
      </div>
      <div class="col-lg-2 col-sm-2">
        <h3>Branding & Legal</h3>
        <ul>
          <li><a href="https://openstack.org/brand/">Logos & Guidelines</a></li>
          <li><a href="https://openstack.org/brand/openstack-trademark-policy/">Trademark Policy</a></li>
          <li><a href="https://openstack.org/privacy/">Privacy Policy</a></li>
          <li><a href="https://wiki.openstack.org/wiki/How_To_Contribute#Contributor_License_Agreement">OpenStack CLA</a></li>
        </ul>
      </div>
      <div class="col-lg-4 col-sm-4">
        <h3>Stay In Touch</h3>
        <a href="https://twitter.com/OpenStack" target="_blank" class="social-icons footer-twitter"></a>
        <a href="https://www.facebook.com/openstack" target="_blank" class="social-icons footer-facebook"></a>
        <a href="https://www.linkedin.com/company/openstack" target="_blank" class="social-icons footer-linkedin"></a>
        <a href="https://www.youtube.com/user/OpenStackFoundation" target="_blank" class="social-icons footer-youtube"></a>
        <p class="fine-print">
          The OpenStack project is provided under the
          <a href="https://www.apache.org/licenses/LICENSE-2.0">Apache 2.0 license</a>. Openstack.org is powered by
          <a href="https://rackspace.com" target="_blank">Rackspace Cloud Computing</a>.
        </p>
      </div>
    </div>
  </div>
</footer>
<!-- jQuery -->
<script type="text/javascript" src="_static/js/jquery-3.2.1.min.js"></script>

<!-- Bootstrap JavaScript -->
<script type="text/javascript" src="_static/js/bootstrap.min.js"></script>

<!-- The rest of the JS -->
<script type="text/javascript" src="_static/js/navigation.js"></script>

<!-- Docs JS -->
<script type="text/javascript" src="_static/js/docs.js"></script>

<!-- standard sphinx include libraries, which allow search highlighting -->
<script type="text/javascript" src="_static/underscore.js"></script>
<script type="text/javascript" src="_static/doctools.js"></script>
<script type="text/javascript" src="_static/searchtools.js"></script>
<script type="text/javascript" src="_static/language_data.js"></script>

<script type="text/javascript">
    var DOCUMENTATION_OPTIONS = {
      URL_ROOT:    './',
      VERSION:     '0.1.0.dev10164',
      COLLAPSE_INDEX: false,
      FILE_SUFFIX: '.html',
      LINK_SUFFIX: '.html',
      SOURCELINK_SUFFIX: '.txt',
      HAS_SOURCE:  true
    };
</script>

<!-- Javascript for page -->
<script language="JavaScript">
  /* Build a description of this page including SHA, source location on git
   * repo, build time and the project's launchpad bug tag. Set the HREF of the
   * bug buttons
   */
    var lineFeed = "%0A";
    var gitURL = "Source: Can't derive source file URL";

    /* there have been cases where "pagename" wasn't set; better check for it */
    /* "giturl" is the URL of the source file on Git and is auto-generated by
     * openstackdocstheme.
     *
     * "pagename" is a standard sphinx parameter containing the name of
     * the source file, without extension.
     */

    var sourceFile = "overview_ring" + ".rst";
    gitURL = "Source: https://opendev.org/openstack/swift/src/doc/source" + "/" + sourceFile;

    /* gitsha, project and bug_tag rely on variables in conf.py */
    var gitSha = "SHA: c7afe681fd119752e66a8e9032e8782641fec3ff";
    var repositoryName = "openstack/swift";
    var bugProject = "swift";
    var bugTitle = "The Rings in Swift";
    var fieldTags = "";
    var useStoryboard = "";

    /* "last_updated" is the build date and time. It relies on the
       conf.py variable "html_last_updated_fmt", which should include
       year/month/day as well as hours and minutes                   */
    var buildstring = "Release: 0.1.0.dev10164 on 2019-09-04 14:30:33";

    var fieldComment = encodeURI(buildstring) +
                       lineFeed + encodeURI(gitSha) +
                       lineFeed + encodeURI(gitURL) ;

    logABug(bugTitle, bugProject, fieldComment, fieldTags, repositoryName, useStoryboard);
    var currentSourceFile = "overview_ring";
    var pdfFileName = "doc-swift.pdf";
    pdfLink(currentSourceFile, pdfFileName);
</script>


  </body>
</html>