
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>Object Encryption &#8212; Swift 0.1.0.dev10162 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/css/basic.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/sphinx_highlight.js"></script>
    <link rel="canonical" href="/openstack-swift/overview_encryption.html" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Using Swift as Backing Store for Service Data" href="overview_backing_store.html" />
    <link rel="prev" title="Erasure Code Support" href="overview_erasure_code.html" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- Bootstrap CSS -->
<link href="_static/css/bootstrap.min.css" rel="stylesheet">

<!-- Fonts -->
<link href="_static/css/font-awesome.min.css" rel="stylesheet">

<!-- Custom CSS -->
<link href="_static/css/combined.css" rel="stylesheet">

<!-- Search CSS -->
<link href="_static/css/search.css" rel="stylesheet">

<!-- Pygments CSS -->
<link href="_static/pygments.css" rel="stylesheet">

<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

<!-- Google Analytics -->
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-17511903-1', 'auto');
ga('send', 'pageview');
</script>
<!-- End Google Analytics -->


  </head><body>

<!-- SOURCE_FILE: https://opendev.org/openstack/swift/src/doc/source/overview_encryption.rst -->

<script>
    (function (window, document) {
        var loader = function () {
            var script = document.createElement("script"), tag = document.getElementsByTagName("script")[0];
            script.src = "https://search.openstack.org/widget/embed.min.js?t="+Date.now();
            tag.parentNode.insertBefore(script, tag);
        };
        window.addEventListener ? window.addEventListener("load", loader, false) : window.attachEvent("onload", loader);
    })(window, document);
</script>

<nav class="navbar navbar-default" role="navigation">
  <div class="container">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button class="navbar-toggle" data-target="#bs-example-navbar-collapse-1" data-toggle="collapse" type="button">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <div class="brand-wrapper">
        <a class="navbar-brand" href="https://www.openstack.org/"></a>
      </div>
      <div class="search-icon show"><i class="fa fa-search"></i> Search</div></div>
      <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <div class="search-container tiny">
    <div class="openstack-search-bar" data-baseUrl="search.openstack.org" data-context="docs-openstack"></div>
</div>
      <ul class="nav navbar-nav navbar-main show">
        <li class="search-container-mobile">
    <div class="openstack-search-bar" data-baseUrl="search.openstack.org" data-context="docs-openstack"></div>
</li>
        <li> <!--Software -->
          <a href="https://www.openstack.org/software/" class="drop" id="dropdownMenuSoftware">Software <i class="fa fa-caret-down"></i></a>
          <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenuSoftware">
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/software/">Overview</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/software/project-navigator/openstack-components">OpenStack Components</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/software/project-navigator/sdks">SDKs</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/software/project-navigator/deployment-tools">Deployment Tools</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/assets/software/projectmap/openstack-map.pdf" target="_blank">OpenStack Map</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/software/sample-configs/">Sample Configs</a></li>
          </ul>
        </li>
        <li> <!-- Use Cases -->
          <a href="https://www.openstack.org/use-cases/" class="drop" id="dropdownMenuUsers">Use Cases <i class="fa fa-caret-down"></i></a>
          <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenuUsers">
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/use-cases/">Users in Production</a></li>
            <li role="presentation" class="divider"></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/use-cases/bare-metal/">Ironic Bare Metal</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/use-cases/edge-computing/">Edge Computing</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/use-cases/telecoms-and-nfv/">Telecom & NFV</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/use-cases/science/">Science and HPC</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/use-cases/containers/">Containers</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/use-cases/enterprise/">Enterprise</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/surveys/landing">User Survey</a></li>
          </ul>
        </li>
        <li> <!-- Events -->
          <a href="https://www.openstack.org/events/" class="drop" id="dropdownMenuEvents">Events <i class="fa fa-caret-down"></i></a>
          <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenuEvents">
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/summit/">Open Infrastructure Summits</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/ptg/">Project Teams Gathering</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/events/opendev-2020/">OpenDev</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/events/community-events/">Community Events</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/events/openstackdays">OpenStack & OpenInfra Days</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/videos/">Summit Videos</a></li>
          </ul>
        </li>
        <li><!-- Community -->
          <a href="https://www.openstack.org/community/" class="drop" id="dropdownMenuCommunity">Community <i class="fa fa-caret-down"></i></a>
          <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenuCommunity">
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/community/">Welcome! Start Here</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/community/tech-committee">OpenStack Technical Committee</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/community/speakers/">Speakers Bureau</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://wiki.openstack.org">OpenStack Wiki</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/coa/">Get Certified (COA)</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/community/jobs/">Jobs</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/marketing/">Marketing Resources</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/news/">Community News</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://superuser.openstack.org">Superuser Magazine</a></li>
            <li role="presentation" class="divider"></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/community/supporting-organizations/">OpenInfra Foundation Supporting Organizations</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://openinfra.dev">Open Infrastructure Foundation (OpenInfra Foundation)</a></li>
          </ul>
        </li>
        <li><!-- Marketplace -->
          <a href="https://www.openstack.orgmarketplace/" class="drop" id="dropdownMenuLearn">Marketplace <i class="fa fa-caret-down"></i></a>
          <ul class="dropdown-menu dropdown-hover" role="menu" aria-labelledby="dropdownMenuEvents">
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/marketplace/training/">Training</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/marketplace/distros/">Distros & Appliances</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/marketplace/public-clouds/">Public Clouds</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/marketplace/hosted-private-clouds/">Hosted Private Clouds</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/marketplace/remotely-managed-private-clouds/">Remotely Managed Private Clouds</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/marketplace/consulting/">Consulting & Integrators</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/marketplace/drivers/">Drivers</a></li>
          </ul>
        </li>
        <li><!-- Blog -->
          <a href="https://www.openstack.org/blog/">Blog</a>
        </li>
        <li><!-- Docs -->
          <a href="http://docs.openstack.org/">Docs</a>
        </li>
        <li> <!-- Join -->
            <li class="join-nav-section">
              <a href="https://openinfra.dev/join/" id="dropdownMenuJoin">Join <i class="fa fa-caret-down"></i></a>
              <ul class="dropdown-menu dropdown-hover" role="menu" aria-labelledby="dropdownMenuJoin" style="display: none;">
                <li role="presentation"><a role="menuitem" tabindex="-1" href="https://openinfra.dev/join/">Sign up for Foundation Membership</a></li>
                <li role="presentation"><a role="menuitem" tabindex="-1" href="https://openinfra.dev/join/">Sponsor the Foundation</a></li>
                <li role="presentation"><a role="menuitem" tabindex="-1" href="https://openinfra.dev">More about the Foundation</a></li>
              </ul>
            </li>
            <li>
              <a href="https://www.openstack.org/Security/login/?BackURL=/home/" class="sign-in-btn">Log In</a>
            </li>
        </li>
      </ul>
    </div>
  </div>
  <!-- /.container -->
</nav>

    <div class="container docs-book-wrapper">
      <div class="row">
        <div class="col-lg-9 col-md-8 col-sm-8 col-lg-push-3 col-md-push-4 col-sm-push-4">
<div class="row docs-title">
  <div class="col-lg-8">
      <h1>Object Encryption</h1>
    
  </div>
  <div class="docs-actions">
    
    <a href="overview_erasure_code.html"><i class="fa fa-angle-double-left" data-toggle="tooltip" data-placement="top" title="Previous: Erasure Code Support"></i></a>
    
    
    <a href="overview_backing_store.html"><i class="fa fa-angle-double-right" data-toggle="tooltip" data-placement="top" title="Next: Using Swift as Backing Store for Service Data"></i></a>
    
    <a id="pdfLink1" href="" target="_blank" title="Download the manuals as PDF"><i class="fa fa-file-pdf-o" data-toggle="tooltip" data-placement="top" title="Download PDF"></i></a>
    
    <a id="logABugLink1" href="" target="_blank" title="Found an error? Report a bug against this page"><i class="fa fa-bug" data-toggle="tooltip" data-placement="top" title="Report a Bug"></i></a>
    
  </div>
</div>
          <div class="row">
            <div class="col-lg-12">
              <div class="docs-body" role="main">

  <section id="object-encryption">
<h1>Object Encryption<a class="headerlink" href="#object-encryption" title="Permalink to this heading">¶</a></h1>
<p>Swift supports the optional encryption of object data at rest on storage nodes.
The encryption of object data is intended to mitigate the risk of users’ data
being read if an unauthorised party were to gain physical access to a disk.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Swift’s data-at-rest encryption accepts plaintext object data from the
client, encrypts it in the cluster, and stores the encrypted data. This
protects object data from inadvertently being exposed if a data drive
leaves the Swift cluster. If a user wishes to ensure that the plaintext
data is always encrypted while in transit and in storage, it is strongly
recommended that the data be encrypted before sending it to the Swift
cluster. Encrypting on the client side is the only way to ensure that the
data is fully encrypted for its entire lifecycle.</p>
</div>
<p>Encryption of data at rest is implemented by middleware that may be included in
the proxy server WSGI pipeline. The feature is internal to a Swift cluster and
not exposed through the API. Clients are unaware that data is encrypted by this
feature internally to the Swift service; internally encrypted data should never
be returned to clients via the Swift API.</p>
<p>The following data are encrypted while at rest in Swift:</p>
<ul class="simple">
<li><p>Object content i.e. the content of an object PUT request’s body</p></li>
<li><p>The entity tag (ETag) of objects that have non-zero content</p></li>
<li><p>All custom user object metadata values i.e. metadata sent using
X-Object-Meta- prefixed headers with PUT or POST requests</p></li>
</ul>
<p>Any data or metadata not included in the list above are not encrypted,
including:</p>
<ul class="simple">
<li><p>Account, container and object names</p></li>
<li><p>Account and container custom user metadata values</p></li>
<li><p>All custom user metadata names</p></li>
<li><p>Object Content-Type values</p></li>
<li><p>Object size</p></li>
<li><p>System metadata</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This feature is intended to provide <cite>confidentiality</cite> of data that is at
rest i.e. to protect user data from being read by an attacker that gains
access to disks on which object data is stored.</p>
<p>This feature is not intended to prevent undetectable <cite>modification</cite>
of user data at rest.</p>
<p>This feature is not intended to protect against an attacker that gains
access to Swift’s internal network connections, or gains access to key
material or is able to modify the Swift code running on Swift nodes.</p>
</div>
<section id="deployment-and-operation">
<span id="encryption-deployment"></span><h2>Deployment and operation<a class="headerlink" href="#deployment-and-operation" title="Permalink to this heading">¶</a></h2>
<p>Encryption is deployed by adding two middleware filters to the proxy
server WSGI pipeline and including their respective filter configuration
sections in the <cite>proxy-server.conf</cite> file. <a class="reference internal" href="#container-sync-client-config"><span class="std std-ref">Additional steps</span></a> are required if the container sync feature is
being used.</p>
<p>The <cite>keymaster</cite> and <cite>encryption</cite> middleware filters must be to the right of all
other middleware in the pipeline apart from the final proxy-logging middleware,
and in the order shown in this example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">other</span> <span class="n">middleware</span><span class="o">&gt;</span> <span class="n">keymaster</span> <span class="n">encryption</span> <span class="n">proxy</span><span class="o">-</span><span class="n">logging</span> <span class="n">proxy</span><span class="o">-</span><span class="n">server</span>

<span class="p">[</span><span class="nb">filter</span><span class="p">:</span><span class="n">keymaster</span><span class="p">]</span>
<span class="n">use</span> <span class="o">=</span> <span class="n">egg</span><span class="p">:</span><span class="n">swift</span><span class="c1">#keymaster</span>
<span class="n">encryption_root_secret</span> <span class="o">=</span> <span class="n">your_secret</span>

<span class="p">[</span><span class="nb">filter</span><span class="p">:</span><span class="n">encryption</span><span class="p">]</span>
<span class="n">use</span> <span class="o">=</span> <span class="n">egg</span><span class="p">:</span><span class="n">swift</span><span class="c1">#encryption</span>
<span class="c1"># disable_encryption = False</span>
</pre></div>
</div>
<p>See the <cite>proxy-server.conf-sample</cite> file for further details on the middleware
configuration options.</p>
<section id="keymaster-middleware">
<h3>Keymaster middleware<a class="headerlink" href="#keymaster-middleware" title="Permalink to this heading">¶</a></h3>
<p>The <cite>keymaster</cite> middleware must be configured with a root secret before it is
used. By default the <cite>keymaster</cite> middleware will use the root secret configured
using the <code class="docutils literal notranslate"><span class="pre">encryption_root_secret</span></code> option in the middleware filter section of
the <cite>proxy-server.conf</cite> file, for example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="nb">filter</span><span class="p">:</span><span class="n">keymaster</span><span class="p">]</span>
<span class="n">use</span> <span class="o">=</span> <span class="n">egg</span><span class="p">:</span><span class="n">swift</span><span class="c1">#keymaster</span>
<span class="n">encryption_root_secret</span> <span class="o">=</span> <span class="n">your_secret</span>
</pre></div>
</div>
<p>Root secret values MUST be at least 44 valid base-64 characters and
should be consistent across all proxy servers. The minimum length of 44 has
been chosen because it is the length of a base-64 encoded 32 byte value.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">encryption_root_secret</span></code> option holds the master secret key used for
encryption.  The security of all encrypted data critically depends on this
key and it should therefore be set to a high-entropy value. For example, a
suitable <code class="docutils literal notranslate"><span class="pre">encryption_root_secret</span></code> may be obtained by base-64 encoding a
32 byte (or longer) value generated by a cryptographically secure random
number generator.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">encryption_root_secret</span></code> value is necessary to recover any encrypted
data from the storage system, and therefore, it must be guarded against
accidental loss. Its value (and consequently, the proxy-server.conf file)
should not be stored on any disk that is in any account, container or
object ring.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">encryption_root_secret</span></code> value should not be changed once deployed.
Doing so would prevent Swift from properly decrypting data that was
encrypted using the former value, and would therefore result in the loss of
that data.</p>
</div>
<p>One method for generating a suitable value for <code class="docutils literal notranslate"><span class="pre">encryption_root_secret</span></code> is to
use the <code class="docutils literal notranslate"><span class="pre">openssl</span></code> command line tool:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">openssl</span> <span class="n">rand</span> <span class="o">-</span><span class="n">base64</span> <span class="mi">32</span>
</pre></div>
</div>
<section id="separate-keymaster-configuration-file">
<h4>Separate keymaster configuration file<a class="headerlink" href="#separate-keymaster-configuration-file" title="Permalink to this heading">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">encryption_root_secret</span></code> option may alternatively be specified in a
separate config file at a path specified by the <code class="docutils literal notranslate"><span class="pre">keymaster_config_path</span></code>
option, for example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="nb">filter</span><span class="p">:</span><span class="n">keymaster</span><span class="p">]</span>
<span class="n">use</span> <span class="o">=</span> <span class="n">egg</span><span class="p">:</span><span class="n">swift</span><span class="c1">#keymaster</span>
<span class="n">keymaster_config_path</span> <span class="o">=</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">swift</span><span class="o">/</span><span class="n">keymaster</span><span class="o">.</span><span class="n">conf</span>
</pre></div>
</div>
<p>This has the advantage of allowing multiple processes which need to be
encryption-aware (for example, proxy-server and container-sync) to share the
same config file, ensuring that consistent encryption keys are used by those
processes. It also allows the keymaster configuration file to have different
permissions than the <cite>proxy-server.conf</cite> file.</p>
<p>A separate keymaster config file should have a <code class="docutils literal notranslate"><span class="pre">[keymaster]</span></code> section
containing the <code class="docutils literal notranslate"><span class="pre">encryption_root_secret</span></code> option:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">keymaster</span><span class="p">]</span>
<span class="n">encryption_root_secret</span> <span class="o">=</span> <span class="n">your_secret</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Alternative keymaster middleware is available to retrieve encryption root
secrets from an <a class="reference internal" href="#encryption-root-secret-in-external-kms"><span class="std std-ref">external key management system</span></a> such as <a class="reference external" href="https://docs.openstack.org/barbican">Barbican</a> rather than storing root secrets in
configuration files.</p>
</div>
<p>Once deployed, the encryption filter will by default encrypt object data and
metadata when handling PUT and POST requests and decrypt object data and
metadata when handling GET and HEAD requests. COPY requests are transformed
into GET and PUT requests by the <a class="reference internal" href="middleware.html#copy"><span class="std std-ref">Server Side Copy</span></a> middleware before reaching the
encryption middleware and as a result object data and metadata is decrypted and
re-encrypted when copied.</p>
</section>
<section id="changing-the-encryption-root-secret">
<span id="changing-the-root-secret"></span><h4>Changing the encryption root secret<a class="headerlink" href="#changing-the-encryption-root-secret" title="Permalink to this heading">¶</a></h4>
<p>From time to time it may be desirable to change the root secret that is used to
derive encryption keys for new data written to the cluster. The <cite>keymaster</cite>
middleware allows alternative root secrets to be specified in its configuration
using options of the form:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">encryption_root_secret_</span><span class="o">&lt;</span><span class="n">secret_id</span><span class="o">&gt;</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">secret</span> <span class="n">value</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">secret_id</span></code> is a unique identifier for the root secret and <code class="docutils literal notranslate"><span class="pre">secret</span>
<span class="pre">value</span></code> is a value that meets the requirements for a root secret described
above.</p>
<p>Only one root secret is used to encrypt new data at any moment in time. This
root secret is specified using the <code class="docutils literal notranslate"><span class="pre">active_root_secret_id</span></code> option. If
specified, the value of this option should be one of the configured root secret
<code class="docutils literal notranslate"><span class="pre">secret_id</span></code> values; otherwise the value of <code class="docutils literal notranslate"><span class="pre">encryption_root_secret</span></code> will be
taken as the default active root secret.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The active root secret is only used to derive keys for new data written to
the cluster. Changing the active root secret does not cause any existing
data to be re-encrypted.</p>
</div>
<p>Existing encrypted data will be decrypted using the root secret that was active
when that data was written. All previous active root secrets must therefore
remain in the middleware configuration in order for decryption of existing data
to succeed.  Existing encrypted data will reference previous root secret by
the <code class="docutils literal notranslate"><span class="pre">secret_id</span></code> so it must be kept consistent in the configuration.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Do not remove or change any previously active <code class="docutils literal notranslate"><span class="pre">&lt;secret</span> <span class="pre">value&gt;</span></code> or <code class="docutils literal notranslate"><span class="pre">&lt;secret_id&gt;</span></code>.</p>
</div>
<p>For example, the following keymaster configuration file specifies three root
secrets, with the value of <code class="docutils literal notranslate"><span class="pre">encryption_root_secret_2</span></code> being the current
active root secret:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">keymaster</span><span class="p">]</span>
<span class="n">active_root_secret_id</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">encryption_root_secret</span> <span class="o">=</span> <span class="n">your_secret</span>
<span class="n">encryption_root_secret_1</span> <span class="o">=</span> <span class="n">your_secret_1</span>
<span class="n">encryption_root_secret_2</span> <span class="o">=</span> <span class="n">your_secret_2</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To ensure there is no loss of data availability, deploying a new key to
your cluster requires a two-stage config change. First, add the new key
to the <code class="docutils literal notranslate"><span class="pre">encryption_root_secret_&lt;secret_id&gt;</span></code> option and restart the
proxy-server. Do this for all proxies. Next, set the
<code class="docutils literal notranslate"><span class="pre">active_root_secret_id</span></code> option to the new secret id and restart the
proxy. Again, do this for all proxies. This process ensures that all
proxies will have the new key available for <em>decryption</em> before any proxy
uses it for <em>encryption</em>.</p>
</div>
</section>
</section>
<section id="encryption-middleware">
<h3>Encryption middleware<a class="headerlink" href="#encryption-middleware" title="Permalink to this heading">¶</a></h3>
<p>Once deployed, the encryption filter will by default encrypt object data and
metadata when handling PUT and POST requests and decrypt object data and
metadata when handling GET and HEAD requests. COPY requests are transformed
into GET and PUT requests by the <a class="reference internal" href="middleware.html#copy"><span class="std std-ref">Server Side Copy</span></a> middleware before reaching the
encryption middleware and as a result object data and metadata is decrypted and
re-encrypted when copied.</p>
</section>
<section id="encryption-root-secret-in-external-key-management-system">
<span id="encryption-root-secret-in-external-kms"></span><h3>Encryption Root Secret in External Key Management System<a class="headerlink" href="#encryption-root-secret-in-external-key-management-system" title="Permalink to this heading">¶</a></h3>
<p>The benefits of using a dedicated system for storing the encryption root secret
include the auditing and access control infrastructure that are already in
place in such a system, and the fact that an encryption root secret stored in a
key management system (KMS) may be backed by a hardware security module (HSM)
for additional security. Another significant benefit of storing the root
encryption secret in an external KMS is that it is in this case never stored on
a disk in the Swift cluster.</p>
<p>Swift supports fetching encryption root secrets from a <a class="reference external" href="https://docs.openstack.org/barbican">Barbican</a> service or a <a class="reference external" href="https://www.oasis-open.org/committees/kmip/">KMIP</a> service using the
<code class="docutils literal notranslate"><span class="pre">kms_keymaster</span></code> or <code class="docutils literal notranslate"><span class="pre">kmip_keymaster</span></code> middleware respectively.</p>
<section id="encryption-root-secret-in-a-barbican-kms">
<h4>Encryption Root Secret in a Barbican KMS<a class="headerlink" href="#encryption-root-secret-in-a-barbican-kms" title="Permalink to this heading">¶</a></h4>
<p>Make sure the required dependencies are installed for retrieving an encryption
root secret from an external KMS. This can be done when installing Swift (add
the <code class="docutils literal notranslate"><span class="pre">-e</span></code> flag to install as a development version) by changing to the Swift
directory and running the following command to install Swift together with
the <code class="docutils literal notranslate"><span class="pre">kms_keymaster</span></code> extra dependencies:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">pip</span> <span class="n">install</span> <span class="o">.</span><span class="p">[</span><span class="n">kms_keymaster</span><span class="p">]</span>
</pre></div>
</div>
<p>Another way to install the dependencies is by making sure the
following lines exist in the requirements.txt file, and installing them using
<code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">-r</span> <span class="pre">requirements.txt</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cryptography</span><span class="o">&gt;=</span><span class="mf">1.6</span>                       <span class="c1"># BSD/Apache-2.0</span>
<span class="n">castellan</span><span class="o">&gt;=</span><span class="mf">0.6.0</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If any of the required packages is already installed, the <code class="docutils literal notranslate"><span class="pre">--upgrade</span></code>
flag may be required for the <code class="docutils literal notranslate"><span class="pre">pip</span></code> commands in order for the required
minimum version to be installed.</p>
</div>
<p>To make use of an encryption root secret stored in an external KMS,
replace the keymaster middleware with the kms_keymaster middleware in the
proxy server WSGI pipeline in <cite>proxy-server.conf</cite>, in the order shown in this
example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">other</span> <span class="n">middleware</span><span class="o">&gt;</span> <span class="n">kms_keymaster</span> <span class="n">encryption</span> <span class="n">proxy</span><span class="o">-</span><span class="n">logging</span> <span class="n">proxy</span><span class="o">-</span><span class="n">server</span>
</pre></div>
</div>
<p>and add a section to the same file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="nb">filter</span><span class="p">:</span><span class="n">kms_keymaster</span><span class="p">]</span>
<span class="n">use</span> <span class="o">=</span> <span class="n">egg</span><span class="p">:</span><span class="n">swift</span><span class="c1">#kms_keymaster</span>
<span class="n">keymaster_config_path</span> <span class="o">=</span> <span class="n">file_with_kms_keymaster_config</span>
</pre></div>
</div>
<p>Create or edit the file <cite>file_with_kms_keymaster_config</cite> referenced above.
For further details on the middleware configuration options, see the
<cite>keymaster.conf-sample</cite> file. An example of the content of this file, with
optional parameters omitted, is below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">kms_keymaster</span><span class="p">]</span>
<span class="n">key_id</span> <span class="o">=</span> <span class="n">changeme</span>
<span class="n">username</span> <span class="o">=</span> <span class="n">swift</span>
<span class="n">password</span> <span class="o">=</span> <span class="n">password</span>
<span class="n">project_name</span> <span class="o">=</span> <span class="n">swift</span>
<span class="n">auth_endpoint</span> <span class="o">=</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">keystonehost</span><span class="p">:</span><span class="mi">5000</span><span class="o">/</span><span class="n">v3</span>
</pre></div>
</div>
<p>The encryption root secret shall be created and stored in the external key
management system before it can be used by the keymaster. It shall be stored
as a symmetric key, with content type <code class="docutils literal notranslate"><span class="pre">application/octet-stream</span></code>,
<code class="docutils literal notranslate"><span class="pre">base64</span></code> content encoding, <code class="docutils literal notranslate"><span class="pre">AES</span></code> algorithm, bit length <code class="docutils literal notranslate"><span class="pre">256</span></code>, and secret
type <code class="docutils literal notranslate"><span class="pre">symmetric</span></code>. The mode <code class="docutils literal notranslate"><span class="pre">ctr</span></code> may also be stored for informational
purposes - it is not currently checked by the keymaster.</p>
<p>The following command can be used to store the currently configured
<code class="docutils literal notranslate"><span class="pre">encryption_root_secret</span></code> value from the <cite>proxy-server.conf</cite> file
in Barbican:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">openstack</span> <span class="n">secret</span> <span class="n">store</span> <span class="o">--</span><span class="n">name</span> <span class="n">swift_root_secret</span> \
<span class="o">--</span><span class="n">payload</span><span class="o">-</span><span class="n">content</span><span class="o">-</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;application/octet-stream&quot;</span> \
<span class="o">--</span><span class="n">payload</span><span class="o">-</span><span class="n">content</span><span class="o">-</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;base64&quot;</span> <span class="o">--</span><span class="n">algorithm</span> <span class="n">aes</span> <span class="o">--</span><span class="n">bit</span><span class="o">-</span><span class="n">length</span> <span class="mi">256</span> \
<span class="o">--</span><span class="n">mode</span> <span class="n">ctr</span> <span class="o">--</span><span class="n">secret</span><span class="o">-</span><span class="nb">type</span> <span class="n">symmetric</span> <span class="o">--</span><span class="n">payload</span> <span class="o">&lt;</span><span class="n">base64_encoded_root_secret</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Alternatively, the existing root secret can also be stored in Barbican using
<a class="reference external" href="https://docs.openstack.org/api-guide/key-manager/secrets.html">curl</a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The credentials used to store the secret in Barbican shall be the same
ones that the proxy server uses to retrieve the secret, i.e., the ones
configured in the <cite>keymaster.conf</cite> file. For clarity reasons the commands
shown here omit the credentials - they may be specified explicitly, or in
environment variables.</p>
</div>
<p>Instead of using an existing root secret, Barbican can also be asked to
generate a new 256-bit root secret, with content type
<code class="docutils literal notranslate"><span class="pre">application/octet-stream</span></code> and algorithm <code class="docutils literal notranslate"><span class="pre">AES</span></code> (the <code class="docutils literal notranslate"><span class="pre">mode</span></code> parameter is
currently optional):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">openstack</span> <span class="n">secret</span> <span class="n">order</span> <span class="n">create</span> <span class="o">--</span><span class="n">name</span> <span class="n">swift_root_secret</span> \
<span class="o">--</span><span class="n">payload</span><span class="o">-</span><span class="n">content</span><span class="o">-</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;application/octet-stream&quot;</span> <span class="o">--</span><span class="n">algorithm</span> <span class="n">aes</span> \
<span class="o">--</span><span class="n">bit</span><span class="o">-</span><span class="n">length</span> <span class="mi">256</span> <span class="o">--</span><span class="n">mode</span> <span class="n">ctr</span> <span class="n">key</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">order</span> <span class="pre">create</span></code> creates an asynchronous request to create the actual
secret.
The order can be retrieved using <code class="docutils literal notranslate"><span class="pre">openstack</span> <span class="pre">secret</span> <span class="pre">order</span> <span class="pre">get</span></code>, and once the
order completes successfully, the output will show the key id of the generated
root secret.
Keys currently stored in Barbican can be listed using the
<code class="docutils literal notranslate"><span class="pre">openstack</span> <span class="pre">secret</span> <span class="pre">list</span></code> command.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Both the order (the asynchronous request for creating or storing a secret),
and the actual secret itself, have similar unique identifiers. Once the
order has been completed, the key id is shown in the output of the <code class="docutils literal notranslate"><span class="pre">order</span>
<span class="pre">get</span></code> command.</p>
</div>
<p>The keymaster uses the explicitly configured username and password (and
project name etc.) from the <cite>keymaster.conf</cite> file for retrieving the encryption
root secret from an external key management system. The <a class="reference external" href="https://docs.openstack.org/castellan/latest/">Castellan library</a> is used to communicate with
Barbican.</p>
<p>For the proxy server, reading the encryption root secret directly from the
<cite>proxy-server.conf</cite> file, from the <cite>keymaster.conf</cite> file pointed to
from the <cite>proxy-server.conf</cite> file, or from an external key management system
such as Barbican, are all functionally equivalent. In case reading the
encryption root secret from the external key management system fails, the
proxy server will not start up. If the encryption root secret is retrieved
successfully, it is cached in memory in the proxy server.</p>
<p>For further details on the configuration options, see the
<cite>[filter:kms_keymaster]</cite> section in the <cite>proxy-server.conf-sample</cite> file, and
the <cite>keymaster.conf-sample</cite> file.</p>
</section>
<section id="encryption-root-secret-in-a-kmip-service">
<h4>Encryption Root Secret in a KMIP service<a class="headerlink" href="#encryption-root-secret-in-a-kmip-service" title="Permalink to this heading">¶</a></h4>
<p>This middleware enables Swift to fetch a root secret from a <a class="reference external" href="https://www.oasis-open.org/committees/kmip/">KMIP</a> service. The
root secret is expected to have been previously created in the <a class="reference external" href="https://www.oasis-open.org/committees/kmip/">KMIP</a> service
and is referenced by its unique identifier. The secret should be an AES-256
symmetric key.</p>
<p>To use this middleware Swift must be installed with the extra required
dependencies:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">pip</span> <span class="n">install</span> <span class="o">.</span><span class="p">[</span><span class="n">kmip_keymaster</span><span class="p">]</span>
</pre></div>
</div>
<p>Add the <code class="docutils literal notranslate"><span class="pre">-e</span></code> flag to install as a development version.</p>
<p>Edit the swift <cite>proxy-server.conf</cite> file to insert the middleware in the wsgi
pipeline, replacing any other keymaster middleware:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">pipeline</span><span class="p">:</span><span class="n">main</span><span class="p">]</span>
<span class="n">pipeline</span> <span class="o">=</span> <span class="n">catch_errors</span> <span class="n">gatekeeper</span> <span class="n">healthcheck</span> <span class="n">proxy</span><span class="o">-</span><span class="n">logging</span> \
    <span class="o">&lt;</span><span class="n">other</span> <span class="n">middleware</span><span class="o">&gt;</span> <span class="n">kmip_keymaster</span> <span class="n">encryption</span> <span class="n">proxy</span><span class="o">-</span><span class="n">logging</span> <span class="n">proxy</span><span class="o">-</span><span class="n">server</span>
</pre></div>
</div>
<p>and add a new filter section:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="nb">filter</span><span class="p">:</span><span class="n">kmip_keymaster</span><span class="p">]</span>
<span class="n">use</span> <span class="o">=</span> <span class="n">egg</span><span class="p">:</span><span class="n">swift</span><span class="c1">#kmip_keymaster</span>
<span class="n">key_id</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">unique</span> <span class="nb">id</span> <span class="n">of</span> <span class="n">secret</span> <span class="n">to</span> <span class="n">be</span> <span class="n">fetched</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">KMIP</span> <span class="n">service</span><span class="o">&gt;</span>
<span class="n">host</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">KMIP</span> <span class="n">server</span> <span class="n">host</span><span class="o">&gt;</span>
<span class="n">port</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">KMIP</span> <span class="n">server</span> <span class="n">port</span><span class="o">&gt;</span>
<span class="n">certfile</span> <span class="o">=</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">client</span><span class="o">/</span><span class="n">cert</span><span class="o">.</span><span class="n">pem</span>
<span class="n">keyfile</span> <span class="o">=</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">client</span><span class="o">/</span><span class="n">key</span><span class="o">.</span><span class="n">pem</span>
<span class="n">ca_certs</span> <span class="o">=</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">server</span><span class="o">/</span><span class="n">cert</span><span class="o">.</span><span class="n">pem</span>
<span class="n">username</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">KMIP</span> <span class="n">username</span><span class="o">&gt;</span>
<span class="n">password</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">KMIP</span> <span class="n">password</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Apart from <code class="docutils literal notranslate"><span class="pre">use</span></code> and <code class="docutils literal notranslate"><span class="pre">key_id</span></code> the options are as defined for a PyKMIP
client. The authoritative definition of these options can be found at
<a class="reference external" href="https://pykmip.readthedocs.io/en/latest/client.html">https://pykmip.readthedocs.io/en/latest/client.html</a>.</p>
<p>The value of the <code class="docutils literal notranslate"><span class="pre">key_id</span></code> option should be the unique identifier for a secret
that will be retrieved from the <a class="reference external" href="https://www.oasis-open.org/committees/kmip/">KMIP</a> service.</p>
<p>The keymaster configuration can alternatively be defined in a separate config
file by using the <code class="docutils literal notranslate"><span class="pre">keymaster_config_path</span></code> option:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="nb">filter</span><span class="p">:</span><span class="n">kmip_keymaster</span><span class="p">]</span>
<span class="n">use</span> <span class="o">=</span> <span class="n">egg</span><span class="p">:</span><span class="n">swift</span><span class="c1">#kmip_keymaster</span>
<span class="n">keymaster_config_path</span> <span class="o">=</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">swift</span><span class="o">/</span><span class="n">kmip_keymaster</span><span class="o">.</span><span class="n">conf</span>
</pre></div>
</div>
<p>In this case, the <code class="docutils literal notranslate"><span class="pre">filter:kmip_keymaster</span></code> section should contain no other
options than <code class="docutils literal notranslate"><span class="pre">use</span></code> and <code class="docutils literal notranslate"><span class="pre">keymaster_config_path</span></code>. All other options should be
defined in the separate config file in a section named <code class="docutils literal notranslate"><span class="pre">kmip_keymaster</span></code>. For
example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">kmip_keymaster</span><span class="p">]</span>
<span class="n">key_id</span> <span class="o">=</span> <span class="mi">1234567890</span>
<span class="n">host</span> <span class="o">=</span> <span class="mf">127.0.0.1</span>
<span class="n">port</span> <span class="o">=</span> <span class="mi">5696</span>
<span class="n">certfile</span> <span class="o">=</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">swift</span><span class="o">/</span><span class="n">kmip_client</span><span class="o">.</span><span class="n">crt</span>
<span class="n">keyfile</span> <span class="o">=</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">swift</span><span class="o">/</span><span class="n">kmip_client</span><span class="o">.</span><span class="n">key</span>
<span class="n">ca_certs</span> <span class="o">=</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">swift</span><span class="o">/</span><span class="n">kmip_server</span><span class="o">.</span><span class="n">crt</span>
<span class="n">username</span> <span class="o">=</span> <span class="n">swift</span>
<span class="n">password</span> <span class="o">=</span> <span class="n">swift_password</span>
</pre></div>
</div>
</section>
<section id="changing-the-encryption-root-secret-of-external-kms-s">
<h4>Changing the encryption root secret of external KMS’s<a class="headerlink" href="#changing-the-encryption-root-secret-of-external-kms-s" title="Permalink to this heading">¶</a></h4>
<p>Because the KMS and KMIP keymaster’s derive from the default KeyMaster they
also have to ability to define multiple keys. The only difference is the key
option names. Instead of using the form <cite>encryption_root_secret_&lt;secret_id&gt;</cite>
both external KMS’s use <cite>key_id_&lt;secret_id&gt;</cite>, as it is an extension of their
existing configuration. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="n">key_id</span> <span class="o">=</span> <span class="mi">1234567890</span>
<span class="n">key_id_foo</span> <span class="o">=</span> <span class="mi">0987654321</span>
<span class="n">key_id_bar</span> <span class="o">=</span> <span class="mi">5432106789</span>
<span class="n">active_root_secret_id</span> <span class="o">=</span> <span class="n">foo</span>
<span class="o">...</span>
</pre></div>
</div>
<p>Other then that, the process is the same as <a class="reference internal" href="#changing-the-root-secret"><span class="std std-ref">Changing the encryption root secret</span></a>.</p>
</section>
</section>
<section id="upgrade-considerations">
<h3>Upgrade Considerations<a class="headerlink" href="#upgrade-considerations" title="Permalink to this heading">¶</a></h3>
<p>When upgrading an existing cluster to deploy encryption, the following sequence
of steps is recommended:</p>
<ol class="arabic simple">
<li><p>Upgrade all object servers</p></li>
<li><p>Upgrade all proxy servers</p></li>
<li><p>Add keymaster and encryption middlewares to every proxy server’s middleware
pipeline with the encryption <code class="docutils literal notranslate"><span class="pre">disable_encryption</span></code> option set to <code class="docutils literal notranslate"><span class="pre">True</span></code>
and the keymaster <code class="docutils literal notranslate"><span class="pre">encryption_root_secret</span></code> value set as described above.</p></li>
<li><p>If required, follow the steps for <a class="reference internal" href="#container-sync-client-config"><span class="std std-ref">Container sync configuration</span></a>.</p></li>
<li><p>Finally, change the encryption <code class="docutils literal notranslate"><span class="pre">disable_encryption</span></code> option to <code class="docutils literal notranslate"><span class="pre">False</span></code></p></li>
</ol>
<p>Objects that existed in the cluster prior to the keymaster and encryption
middlewares being deployed are still readable with GET and HEAD requests. The
content of those objects will not be encrypted unless they are written again by
a PUT or COPY request. Any user metadata of those objects will not be encrypted
unless it is written again by a PUT, POST or COPY request.</p>
</section>
<section id="disabling-encryption">
<h3>Disabling Encryption<a class="headerlink" href="#disabling-encryption" title="Permalink to this heading">¶</a></h3>
<p>Once deployed, the keymaster and encryption middlewares should not be removed
from the pipeline. To do so will cause encrypted object data and/or metadata to
be returned in response to GET or HEAD requests for objects that were
previously encrypted.</p>
<p>Encryption of inbound object data may be disabled by setting the encryption
<code class="docutils literal notranslate"><span class="pre">disable_encryption</span></code> option to <code class="docutils literal notranslate"><span class="pre">True</span></code>, in which case existing encrypted
objects will remain encrypted but new data written with PUT, POST or COPY
requests will not be encrypted. The keymaster and encryption middlewares should
remain in the pipeline even when encryption of new objects is not required. The
encryption middleware is needed to handle GET requests for objects that may
have been previously encrypted. The keymaster is needed to provide keys for
those requests.</p>
</section>
<section id="container-sync-configuration">
<span id="container-sync-client-config"></span><h3>Container sync configuration<a class="headerlink" href="#container-sync-configuration" title="Permalink to this heading">¶</a></h3>
<p>If container sync is being used then the keymaster and encryption middlewares
must be added to the container sync internal client pipeline. The following
configuration steps are required:</p>
<ol class="arabic">
<li><p>Create a custom internal client configuration file for container sync (if
one is not already in use) based on the sample file
<cite>internal-client.conf-sample</cite>. For example, copy
<cite>internal-client.conf-sample</cite> to <cite>/etc/swift/container-sync-client.conf</cite>.</p></li>
<li><p>Modify this file to include the middlewares in the pipeline in
the same way as described above for the proxy server.</p></li>
<li><p>Modify the container-sync section of all container server config files to
point to this internal client config file using the
<code class="docutils literal notranslate"><span class="pre">internal_client_conf_path</span></code> option. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">internal_client_conf_path</span> <span class="o">=</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">swift</span><span class="o">/</span><span class="n">container</span><span class="o">-</span><span class="n">sync</span><span class="o">-</span><span class="n">client</span><span class="o">.</span><span class="n">conf</span>
</pre></div>
</div>
</li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">encryption_root_secret</span></code> value is necessary to recover any encrypted
data from the storage system, and therefore, it must be guarded against
accidental loss. Its value (and consequently, the custom internal client
configuration file) should not be stored on any disk that is in any
account, container or object ring.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>These container sync configuration steps will be necessary for container
sync probe tests to pass if the encryption middlewares are included in the
proxy pipeline of a test cluster.</p>
</div>
</section>
</section>
<section id="implementation">
<h2>Implementation<a class="headerlink" href="#implementation" title="Permalink to this heading">¶</a></h2>
<section id="encryption-scheme">
<h3>Encryption scheme<a class="headerlink" href="#encryption-scheme" title="Permalink to this heading">¶</a></h3>
<p>Plaintext data is encrypted to ciphertext using the AES cipher with 256-bit
keys implemented by the python <a class="reference external" href="https://pypi.org/project/cryptography">cryptography package</a>. The cipher is used in counter
(CTR) mode so that any byte or range of bytes in the ciphertext may be
decrypted independently of any other bytes in the ciphertext. This enables very
simple handling of ranged GETs.</p>
<p>In general an item of unencrypted data, <code class="docutils literal notranslate"><span class="pre">plaintext</span></code>, is transformed to an
item of encrypted data, <code class="docutils literal notranslate"><span class="pre">ciphertext</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ciphertext</span> <span class="o">=</span> <span class="n">E</span><span class="p">(</span><span class="n">plaintext</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">iv</span><span class="p">)</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">E</span></code> is the encryption function, <code class="docutils literal notranslate"><span class="pre">k</span></code> is an encryption key and <code class="docutils literal notranslate"><span class="pre">iv</span></code>
is a unique initialization vector (IV) chosen for each encryption context. For
example, the object body is one encryption context with a randomly chosen IV.
The IV is stored as metadata of the encrypted item so that it is available for
decryption:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">plaintext</span> <span class="o">=</span> <span class="n">D</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">iv</span><span class="p">)</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">D</span></code> is the decryption function.</p>
<p>The implementation of CTR mode follows <a class="reference external" href="http://csrc.nist.gov/publications/nistpubs/800-38a/sp800-38a.pdf">NIST SP800-38A</a>, and the
full IV passed to the encryption or decryption function serves as the initial
counter block.</p>
<p>In general any encrypted item has accompanying crypto-metadata that describes
the IV and the cipher algorithm used for the encryption:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">crypto_metadata</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;iv&quot;</span><span class="p">:</span> <span class="o">&lt;</span><span class="mi">16</span> <span class="n">byte</span> <span class="n">value</span><span class="o">&gt;</span><span class="p">,</span>
                   <span class="s2">&quot;cipher&quot;</span><span class="p">:</span> <span class="s2">&quot;AES_CTR_256&quot;</span><span class="p">}</span>
</pre></div>
</div>
<p>This crypto-metadata is stored either with the ciphertext (for user
metadata and etags) or as a separate header (for object bodies).</p>
</section>
<section id="key-management">
<h3>Key management<a class="headerlink" href="#key-management" title="Permalink to this heading">¶</a></h3>
<p>A keymaster middleware is responsible for providing the keys required for each
encryption and decryption operation. Two keys are required when handling object
requests: a <cite>container key</cite> that is uniquely associated with the container path
and an <cite>object key</cite> that is uniquely associated with the object path.  These
keys are made available to the encryption middleware via a callback function
that the keymaster installs in the WSGI request environ.</p>
<p>The current keymaster implementation derives container and object keys from the
<code class="docutils literal notranslate"><span class="pre">encryption_root_secret</span></code> in a deterministic way by constructing a SHA256
HMAC using the <code class="docutils literal notranslate"><span class="pre">encryption_root_secret</span></code> as a key and the container or object
path as a message, for example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">object_key</span> <span class="o">=</span> <span class="n">HMAC</span><span class="p">(</span><span class="n">encryption_root_secret</span><span class="p">,</span> <span class="s2">&quot;/a/c/o&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Other strategies for providing object and container keys may be employed by
future implementations of alternative keymaster middleware.</p>
<p>During each object PUT, a random key is generated to encrypt the object body.
This random key is then encrypted using the object key provided by the
keymaster. This makes it safe to store the encrypted random key alongside the
encrypted object data and metadata.</p>
<p>This process of <cite>key wrapping</cite> enables more efficient re-keying events when the
object key may need to be replaced and consequently any data encrypted using
that key must be re-encrypted. Key wrapping minimizes the amount of data
encrypted using those keys to just other randomly chosen keys which can be
re-wrapped efficiently without needing to re-encrypt the larger amounts of data
that were encrypted using the random keys.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Re-keying is not currently implemented. Key wrapping is implemented
in anticipation of future re-keying operations.</p>
</div>
</section>
<section id="id2">
<h3>Encryption middleware<a class="headerlink" href="#id2" title="Permalink to this heading">¶</a></h3>
<p>The encryption middleware is composed of an <cite>encrypter</cite> component and a
<cite>decrypter</cite> component.</p>
<section id="encrypter-operation">
<h4>Encrypter operation<a class="headerlink" href="#encrypter-operation" title="Permalink to this heading">¶</a></h4>
<section id="custom-user-metadata">
<h5>Custom user metadata<a class="headerlink" href="#custom-user-metadata" title="Permalink to this heading">¶</a></h5>
<p>The encrypter encrypts each item of custom user metadata using the object key
provided by the keymaster and an IV that is randomly chosen for that metadata
item. The encrypted values are stored as <a class="reference internal" href="development_middleware.html#transient-sysmeta"><span class="std std-ref">Object Transient-Sysmeta</span></a> with
associated crypto-metadata appended to the encrypted value. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">X</span><span class="o">-</span><span class="n">Object</span><span class="o">-</span><span class="n">Meta</span><span class="o">-</span><span class="n">Private1</span><span class="p">:</span> <span class="n">value1</span>
<span class="n">X</span><span class="o">-</span><span class="n">Object</span><span class="o">-</span><span class="n">Meta</span><span class="o">-</span><span class="n">Private2</span><span class="p">:</span> <span class="n">value2</span>
</pre></div>
</div>
<p>are transformed to:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">X</span><span class="o">-</span><span class="n">Object</span><span class="o">-</span><span class="n">Transient</span><span class="o">-</span><span class="n">Sysmeta</span><span class="o">-</span><span class="n">Crypto</span><span class="o">-</span><span class="n">Meta</span><span class="o">-</span><span class="n">Private1</span><span class="p">:</span>
  <span class="n">E</span><span class="p">(</span><span class="n">value1</span><span class="p">,</span> <span class="n">object_key</span><span class="p">,</span> <span class="n">header_iv_1</span><span class="p">);</span> <span class="n">swift_meta</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;iv&quot;</span><span class="p">:</span> <span class="n">header_iv_1</span><span class="p">,</span>
                                                  <span class="s2">&quot;cipher&quot;</span><span class="p">:</span> <span class="s2">&quot;AES_CTR_256&quot;</span><span class="p">}</span>
<span class="n">X</span><span class="o">-</span><span class="n">Object</span><span class="o">-</span><span class="n">Transient</span><span class="o">-</span><span class="n">Sysmeta</span><span class="o">-</span><span class="n">Crypto</span><span class="o">-</span><span class="n">Meta</span><span class="o">-</span><span class="n">Private2</span><span class="p">:</span>
  <span class="n">E</span><span class="p">(</span><span class="n">value2</span><span class="p">,</span> <span class="n">object_key</span><span class="p">,</span> <span class="n">header_iv_2</span><span class="p">);</span> <span class="n">swift_meta</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;iv&quot;</span><span class="p">:</span> <span class="n">header_iv_2</span><span class="p">,</span>
                                                  <span class="s2">&quot;cipher&quot;</span><span class="p">:</span> <span class="s2">&quot;AES_CTR_256&quot;</span><span class="p">}</span>
</pre></div>
</div>
<p>The unencrypted custom user metadata headers are removed.</p>
</section>
<section id="object-body">
<h5>Object body<a class="headerlink" href="#object-body" title="Permalink to this heading">¶</a></h5>
<p>Encryption of an object body is performed using a randomly chosen body key
and a randomly chosen IV:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">body_ciphertext</span> <span class="o">=</span> <span class="n">E</span><span class="p">(</span><span class="n">body_plaintext</span><span class="p">,</span> <span class="n">body_key</span><span class="p">,</span> <span class="n">body_iv</span><span class="p">)</span>
</pre></div>
</div>
<p>The body_key is wrapped using the object key provided by the keymaster and a
randomly chosen IV:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wrapped_body_key</span> <span class="o">=</span> <span class="n">E</span><span class="p">(</span><span class="n">body_key</span><span class="p">,</span> <span class="n">object_key</span><span class="p">,</span> <span class="n">body_key_iv</span><span class="p">)</span>
</pre></div>
</div>
<p>The encrypter stores the associated crypto-metadata in a system metadata
header:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">X</span><span class="o">-</span><span class="n">Object</span><span class="o">-</span><span class="n">Sysmeta</span><span class="o">-</span><span class="n">Crypto</span><span class="o">-</span><span class="n">Body</span><span class="o">-</span><span class="n">Meta</span><span class="p">:</span>
    <span class="p">{</span><span class="s2">&quot;iv&quot;</span><span class="p">:</span> <span class="n">body_iv</span><span class="p">,</span>
     <span class="s2">&quot;cipher&quot;</span><span class="p">:</span> <span class="s2">&quot;AES_CTR_256&quot;</span><span class="p">,</span>
     <span class="s2">&quot;body_key&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">wrapped_body_key</span><span class="p">,</span>
                  <span class="s2">&quot;iv&quot;</span><span class="p">:</span> <span class="n">body_key_iv</span><span class="p">}}</span>
</pre></div>
</div>
<p>Note that in this case there is an extra item of crypto-metadata which stores
the wrapped body key and its IV.</p>
</section>
<section id="entity-tag">
<h5>Entity tag<a class="headerlink" href="#entity-tag" title="Permalink to this heading">¶</a></h5>
<p>While encrypting the object body the encrypter also calculates the ETag (md5
digest) of the plaintext body. This value is encrypted using the object key
provided by the keymaster and a randomly chosen IV, and saved as an item of
system metadata, with associated crypto-metadata appended to the encrypted
value:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">X</span><span class="o">-</span><span class="n">Object</span><span class="o">-</span><span class="n">Sysmeta</span><span class="o">-</span><span class="n">Crypto</span><span class="o">-</span><span class="n">Etag</span><span class="p">:</span>
  <span class="n">E</span><span class="p">(</span><span class="n">md5</span><span class="p">(</span><span class="n">plaintext</span><span class="p">),</span> <span class="n">object_key</span><span class="p">,</span> <span class="n">etag_iv</span><span class="p">);</span> <span class="n">swift_meta</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;iv&quot;</span><span class="p">:</span> <span class="n">etag_iv</span><span class="p">,</span>
                                                      <span class="s2">&quot;cipher&quot;</span><span class="p">:</span> <span class="s2">&quot;AES_CTR_256&quot;</span><span class="p">}</span>
</pre></div>
</div>
<p>The encrypter also forces an encrypted version of the plaintext ETag to be sent
with container updates by adding an update override header to the PUT request.
The associated crypto-metadata is appended to the encrypted ETag value of this
update override header:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">X</span><span class="o">-</span><span class="n">Object</span><span class="o">-</span><span class="n">Sysmeta</span><span class="o">-</span><span class="n">Container</span><span class="o">-</span><span class="n">Update</span><span class="o">-</span><span class="n">Override</span><span class="o">-</span><span class="n">Etag</span><span class="p">:</span>
    <span class="n">E</span><span class="p">(</span><span class="n">md5</span><span class="p">(</span><span class="n">plaintext</span><span class="p">),</span> <span class="n">container_key</span><span class="p">,</span> <span class="n">override_etag_iv</span><span class="p">);</span>
    <span class="n">meta</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;iv&quot;</span><span class="p">:</span> <span class="n">override_etag_iv</span><span class="p">,</span> <span class="s2">&quot;cipher&quot;</span><span class="p">:</span> <span class="s2">&quot;AES_CTR_256&quot;</span><span class="p">}</span>
</pre></div>
</div>
<p>The container key is used for this encryption so that the decrypter is able
to decrypt the ETags in container listings when handling a container request,
since object keys may not be available in that context.</p>
<p>Since the plaintext ETag value is only known once the encrypter has completed
processing the entire object body, the <code class="docutils literal notranslate"><span class="pre">X-Object-Sysmeta-Crypto-Etag</span></code> and
<code class="docutils literal notranslate"><span class="pre">X-Object-Sysmeta-Container-Update-Override-Etag</span></code> headers are sent after the
encrypted object body using the proxy server’s support for request footers.</p>
</section>
<section id="conditional-requests">
<span id="id3"></span><h5>Conditional Requests<a class="headerlink" href="#conditional-requests" title="Permalink to this heading">¶</a></h5>
<p>In general, an object server evaluates conditional requests with
<code class="docutils literal notranslate"><span class="pre">If[-None]-Match</span></code> headers by comparing values listed in an
<code class="docutils literal notranslate"><span class="pre">If[-None]-Match</span></code> header against the ETag that is stored in the object
metadata. This is not possible when the ETag stored in object metadata has been
encrypted. The encrypter therefore calculates an HMAC using the object key and
the ETag while handling object PUT requests, and stores this under the metadata
key <code class="docutils literal notranslate"><span class="pre">X-Object-Sysmeta-Crypto-Etag-Mac</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">X</span><span class="o">-</span><span class="n">Object</span><span class="o">-</span><span class="n">Sysmeta</span><span class="o">-</span><span class="n">Crypto</span><span class="o">-</span><span class="n">Etag</span><span class="o">-</span><span class="n">Mac</span><span class="p">:</span> <span class="n">HMAC</span><span class="p">(</span><span class="n">object_key</span><span class="p">,</span> <span class="n">md5</span><span class="p">(</span><span class="n">plaintext</span><span class="p">))</span>
</pre></div>
</div>
<p>Like other ETag-related metadata, this is sent after the encrypted object body
using the proxy server’s support for request footers.</p>
<p>The encrypter similarly calculates an HMAC for each ETag value included in
<code class="docutils literal notranslate"><span class="pre">If[-None]-Match</span></code> headers of conditional GET or HEAD requests, and appends
these to the <code class="docutils literal notranslate"><span class="pre">If[-None]-Match</span></code> header. The encrypter also sets the
<code class="docutils literal notranslate"><span class="pre">X-Backend-Etag-Is-At</span></code> header to point to the previously stored
<code class="docutils literal notranslate"><span class="pre">X-Object-Sysmeta-Crypto-Etag-Mac</span></code> metadata so that the object server
evaluates the conditional request by comparing the HMAC values included in the
<code class="docutils literal notranslate"><span class="pre">If[-None]-Match</span></code> with the value stored under
<code class="docutils literal notranslate"><span class="pre">X-Object-Sysmeta-Crypto-Etag-Mac</span></code>. For example, given a conditional request
with header:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">If</span><span class="o">-</span><span class="n">Match</span><span class="p">:</span> <span class="n">match_etag</span>
</pre></div>
</div>
<p>the encrypter would transform the request headers to include:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">If</span><span class="o">-</span><span class="n">Match</span><span class="p">:</span> <span class="n">match_etag</span><span class="p">,</span><span class="n">HMAC</span><span class="p">(</span><span class="n">object_key</span><span class="p">,</span> <span class="n">match_etag</span><span class="p">)</span>
<span class="n">X</span><span class="o">-</span><span class="n">Backend</span><span class="o">-</span><span class="n">Etag</span><span class="o">-</span><span class="n">Is</span><span class="o">-</span><span class="n">At</span><span class="p">:</span> <span class="n">X</span><span class="o">-</span><span class="n">Object</span><span class="o">-</span><span class="n">Sysmeta</span><span class="o">-</span><span class="n">Crypto</span><span class="o">-</span><span class="n">Etag</span><span class="o">-</span><span class="n">Mac</span>
</pre></div>
</div>
<p>This enables the object server to perform an encrypted comparison to check
whether the ETags match, without leaking the ETag itself or leaking information
about the object body.</p>
</section>
</section>
<section id="decrypter-operation">
<h4>Decrypter operation<a class="headerlink" href="#decrypter-operation" title="Permalink to this heading">¶</a></h4>
<p>For each GET or HEAD request to an object, the decrypter inspects the response
for encrypted items (revealed by crypto-metadata headers), and if any are
discovered then it will:</p>
<ol class="arabic simple">
<li><p>Fetch the object and container keys from the keymaster via its callback</p></li>
<li><p>Decrypt the <code class="docutils literal notranslate"><span class="pre">X-Object-Sysmeta-Crypto-Etag</span></code> value</p></li>
<li><p>Decrypt the <code class="docutils literal notranslate"><span class="pre">X-Object-Sysmeta-Container-Update-Override-Etag</span></code> value</p></li>
<li><p>Decrypt metadata header values using the object key</p></li>
<li><p>Decrypt the wrapped body key found in <code class="docutils literal notranslate"><span class="pre">X-Object-Sysmeta-Crypto-Body-Meta</span></code></p></li>
<li><p>Decrypt the body using the body key</p></li>
</ol>
<p>For each GET request to a container that would include ETags in its response
body, the decrypter will:</p>
<ol class="arabic simple">
<li><p>GET the response body with the container listing</p></li>
<li><p>Fetch the container key from the keymaster via its callback</p></li>
<li><p>Decrypt any encrypted ETag entries in the container listing using the
container key</p></li>
</ol>
</section>
</section>
<section id="impact-on-other-swift-services-and-features">
<h3>Impact on other Swift services and features<a class="headerlink" href="#impact-on-other-swift-services-and-features" title="Permalink to this heading">¶</a></h3>
<p>Encryption has no impact on <a class="reference internal" href="middleware.html#versioned-writes"><span class="std std-ref">Versioned Writes</span></a> other than that any
previously unencrypted objects will be encrypted as they are copied to or from
the versions container. Keymaster and encryption middlewares should be placed
after <code class="docutils literal notranslate"><span class="pre">versioned_writes</span></code> in the proxy server pipeline, as described in
<a class="reference internal" href="#encryption-deployment"><span class="std std-ref">Deployment and operation</span></a>.</p>
<p><cite>Container Sync</cite> uses an internal client to GET objects that are to be sync’d.
This internal client must be configured to use the keymaster and encryption
middlewares as described <a class="reference internal" href="#container-sync-client-config"><span class="std std-ref">above</span></a>.</p>
<p>Encryption has no impact on the <cite>object-auditor</cite> service. Since the ETag
header saved with the object at rest is the md5 sum of the encrypted object
body then the auditor will verify that encrypted data is valid.</p>
<p>Encryption has no impact on the <cite>object-expirer</cite> service. <code class="docutils literal notranslate"><span class="pre">X-Delete-At</span></code> and
<code class="docutils literal notranslate"><span class="pre">X-Delete-After</span></code> headers are not encrypted.</p>
<p>Encryption has no impact on the <cite>object-replicator</cite> and <cite>object-reconstructor</cite>
services. These services are unaware of the object or EC fragment data being
encrypted.</p>
<p>Encryption has no impact on the <cite>container-reconciler</cite> service. The
<cite>container-reconciler</cite> uses an internal client to move objects between
different policy rings. The reconciler’s pipeline <em>MUST NOT</em> have encryption
enabled. The destination object has the same URL as the source object and the
object is moved without re-encryption.</p>
</section>
<section id="considerations-for-developers">
<h3>Considerations for developers<a class="headerlink" href="#considerations-for-developers" title="Permalink to this heading">¶</a></h3>
<p>Developers should be aware that keymaster and encryption middlewares rely on
the path of an object remaining unchanged. The included keymaster derives keys
for containers and objects based on their paths and the
<code class="docutils literal notranslate"><span class="pre">encryption_root_secret</span></code>. The keymaster does not rely on object metadata to
inform its generation of keys for GET and HEAD requests because when handling
<a class="reference internal" href="#conditional-requests"><span class="std std-ref">Conditional Requests</span></a> it is required to provide the object key before any
metadata has been read from the object.</p>
<p>Developers should therefore give careful consideration to any new features that
would relocate object data and metadata within a Swift cluster by means that do
not cause the object data and metadata to pass through the encryption
middlewares in the proxy pipeline and be re-encrypted.</p>
<p>The crypto-metadata associated with each encrypted item does include some
<cite>key_id</cite> metadata that is provided by the keymaster and contains the path used
to derive keys. This <cite>key_id</cite> metadata is persisted in anticipation of future
scenarios when it may be necessary to decrypt an object that has been relocated
without re-encrypting, in which case the metadata could be used to derive the
keys that were used for encryption. However, this alone is not sufficient to
handle conditional requests and to decrypt container listings where objects
have been relocated, and further work will be required to solve those issues.</p>
</section>
</section>
</section>


              </div>
            </div>
          </div>
          <div class="docs-actions">
          
            <a href="overview_erasure_code.html"><i class="fa fa-angle-double-left" data-toggle="tooltip" data-placement="top" title="Previous: Erasure Code Support"></i></a>
          
          
            <a href="overview_backing_store.html"><i class="fa fa-angle-double-right" data-toggle="tooltip" data-placement="top" title="Next: Using Swift as Backing Store for Service Data"></i></a>
          
          <a id="pdfLink2" href="" target="_blank" title="Download the manuals as PDF"><i class="fa fa-file-pdf-o" data-toggle="tooltip" data-placement="top" title="Download PDF"></i></a>
          
            <a id="logABugLink3" href="" target="_blank" title="Found an error? Report a bug against this page"><i class="fa fa-bug" data-toggle="tooltip" data-placement="top" title="Report a Bug"></i></a>
          
          </div>
          <div class="row docs-byline bottom">
            <div class="docs-updated">this page last updated: 2021-01-21 11:53:09</div>
          </div>
          <div class="row">
            <div class="col-lg-8 col-md-8 col-sm-8 docs-license">
<a href="https://creativecommons.org/licenses/by/3.0/">
 <img src="_static/images/docs/license.png" alt="Creative Commons Attribution 3.0 License"/>
</a>
<p>
 Except where otherwise noted, this document is licensed under
 <a href="https://creativecommons.org/licenses/by/3.0/">Creative Commons
 Attribution 3.0 License</a>. See all <a href="https://www.openstack.org/legal">
 OpenStack Legal Documents</a>.
</p>
            </div>
            <div class="col-lg-4 col-md-4 col-sm-4 docs-actions-wrapper">
            <!-- ID buglinkbottom added so that pre-filled doc bugs
                 are sent to Launchpad projects related to the
                 document -->
              <a href="#" id="logABugLink2" class="docs-footer-actions"><i class="fa fa-bug"></i> found an error? report a bug</a>
            </div>
          </div>
        </div>
<div class="col-lg-3 col-md-4 col-sm-4 col-lg-pull-9 col-md-pull-8 col-sm-pull-8 docs-sidebar">
  <div class="btn-group docs-sidebar-releases">
    <button onclick="location.href='/'" class="btn docs-sidebar-home" data-toggle="tooltip" data-placement="top" title="OpenStack Docs Home"><i class="fa fa-arrow-circle-o-left"></i></button>
<button href="#" type="button" data-toggle="dropdown" class="btn docs-sidebar-release-select">OpenStack Documentation<i class="fa fa-caret-down"></i></button>
    <ul class="dropdown-menu docs-sidebar-dropdown" role="menu" aria-labelledby="dLabel">
      <li role="presentation" class="dropdown-header">Guides</li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="https://docs.openstack.org/index.html#install-guides">Install Guides</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="https://docs.openstack.org/index.html#user-guides">User Guides</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="https://docs.openstack.org/index.html#configuration-guides">Configuration Guides</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="https://docs.openstack.org/index.html#ops-and-admin-guides">Operations and Administration Guides</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="https://docs.openstack.org/index.html#api-guides">API Guides</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="https://docs.openstack.org/index.html#contributor-guides">Contributor Guides</a></li>
      <li role="presentation" class="dropdown-header">Languages</li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="https://docs.openstack.org/de/">Deutsch (German)</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="https://docs.openstack.org/fr/">Français (French)</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="https://docs.openstack.org/id/">Bahasa Indonesia (Indonesian)</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="https://docs.openstack.org/it/">Italiano (Italian)</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="https://docs.openstack.org/ja/">日本語 (Japanese)</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="https://docs.openstack.org/ko_KR/">한국어 (Korean)</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="https://docs.openstack.org/pt_BR/">Português (Portuguese)</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="https://docs.openstack.org/tr_TR/">Türkçe (Türkiye)</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="https://docs.openstack.org/zh_CN/">简体中文 (Simplified Chinese)</a></li>
    </ul>
  </div>
  <div class="docs-sidebar-toc">
    <div class="docs-sidebar-section" id="table-of-contents">
      <a href="index.html" class="docs-sidebar-section-title"><h4>Swift 0.1.0.dev10162</h4></a>
      <ul>
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">Getting Started</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="api/object_api_v1_overview.html">Object Storage API overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="overview_architecture.html">Swift Architectural Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="overview_ring.html">The Rings</a></li>
<li class="toctree-l1"><a class="reference internal" href="overview_policies.html">Storage Policies</a></li>
<li class="toctree-l1"><a class="reference internal" href="overview_reaper.html">The Account Reaper</a></li>
<li class="toctree-l1"><a class="reference internal" href="overview_auth.html">The Auth System</a></li>
<li class="toctree-l1"><a class="reference internal" href="overview_acl.html">Access Control Lists (ACLs)</a></li>
<li class="toctree-l1"><a class="reference internal" href="overview_replication.html">Replication</a></li>
<li class="toctree-l1"><a class="reference internal" href="ratelimit.html">Rate Limiting</a></li>
<li class="toctree-l1"><a class="reference internal" href="overview_large_objects.html">Large Object Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="overview_global_cluster.html">Global Clusters</a></li>
<li class="toctree-l1"><a class="reference internal" href="overview_container_sync.html">Container to Container Synchronization</a></li>
<li class="toctree-l1"><a class="reference internal" href="overview_expiring_objects.html">Expiring Object Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="cors.html">CORS</a></li>
<li class="toctree-l1"><a class="reference internal" href="crossdomain.html">Cross-domain Policy File</a></li>
<li class="toctree-l1"><a class="reference internal" href="overview_erasure_code.html">Erasure Code Support</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Object Encryption</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#deployment-and-operation">Deployment and operation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#implementation">Implementation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="overview_backing_store.html">Using Swift as Backing Store for Service Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="overview_container_sharding.html">Container Sharding</a></li>
<li class="toctree-l1"><a class="reference internal" href="ring_background.html">Building a Consistent Hashing Ring</a></li>
<li class="toctree-l1"><a class="reference internal" href="ring_partpower.html">Modifying Ring Partition Power</a></li>
<li class="toctree-l1"><a class="reference internal" href="associated_projects.html">Associated Projects</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="contributor/contributing.html">Contributing to OpenStack Swift</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributor/contributing.html#swift-design-principles">Swift Design Principles</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributor/contributing.html#recommended-workflow">Recommended workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributor/contributing.html#notes-on-testing">Notes on Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributor/contributing.html#ideas">Ideas</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributor/contributing.html#community">Community</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributor/review_guidelines.html">Review Guidelines</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="development_guidelines.html">Development Guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="development_saio.html">SAIO (Swift All In One)</a></li>
<li class="toctree-l1"><a class="reference internal" href="first_contribution_swift.html">First Contribution to Swift</a></li>
<li class="toctree-l1"><a class="reference internal" href="policies_saio.html">Adding Storage Policies to an Existing SAIO</a></li>
<li class="toctree-l1"><a class="reference internal" href="development_auth.html">Auth Server and Middleware</a></li>
<li class="toctree-l1"><a class="reference internal" href="development_middleware.html">Middleware and Metadata</a></li>
<li class="toctree-l1"><a class="reference internal" href="development_ondisk_backends.html">Pluggable On-Disk Back-end APIs</a></li>
<li class="toctree-l1"><a class="reference internal" href="development_watchers.html">Auditor Watchers</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="deployment_guide.html">Deployment Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="apache_deployment_guide.html">Apache Deployment Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="admin_guide.html">Administrator’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="replication_network.html">Dedicated replication network</a></li>
<li class="toctree-l1"><a class="reference internal" href="logs.html">Logs</a></li>
<li class="toctree-l1"><a class="reference internal" href="ops_runbook/index.html">Swift Ops Runbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="admin/index.html">OpenStack Swift Administrator Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="install/index.html">Object Storage Install Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="config/index.html">Configuration Documentation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="api/object_api_v1_overview.html">Object Storage API overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/discoverability.html">Discoverability</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/authentication.html">Authentication</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/container_quotas.html">Container quotas</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/object_versioning.html">Object versioning</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/large_objects.html">Large objects</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/temporary_url_middleware.html">Temporary URL middleware</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/form_post_middleware.html">Form POST middleware</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/use_content-encoding_metadata.html">Use Content-Encoding metadata</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/use_the_content-disposition_metadata.html">Use the Content-Disposition metadata</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/pseudo-hierarchical-folders-directories.html">Pseudo-hierarchical folders and directories</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/pagination.html">Page through large lists of containers or objects</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/serialized-response-formats.html">Serialized response formats</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/static-website.html">Create static website</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/object-expiration.html">Object expiration</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/bulk-delete.html">Bulk delete</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="s3_compat.html">S3/Swift REST API Comparison Matrix</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="ring.html">Partitioned Consistent Hash Ring</a></li>
<li class="toctree-l1"><a class="reference internal" href="proxy.html">Proxy</a></li>
<li class="toctree-l1"><a class="reference internal" href="account.html">Account</a></li>
<li class="toctree-l1"><a class="reference internal" href="container.html">Container</a></li>
<li class="toctree-l1"><a class="reference internal" href="db.html">Account DB and Container DB</a></li>
<li class="toctree-l1"><a class="reference internal" href="object.html">Object</a></li>
<li class="toctree-l1"><a class="reference internal" href="misc.html">Misc</a></li>
<li class="toctree-l1"><a class="reference internal" href="middleware.html">Middleware</a></li>
<li class="toctree-l1"><a class="reference internal" href="audit_watchers.html">Object Audit Watchers</a></li>
</ul>

    </div>

  <div class="docs-sidebar-toc">
    <div class="docs-sidebar-section" id="local-table-of-contents">
      <h4 class="docs-sidebar-section-title">Page Contents</h4>
      <ul>
<li><a class="reference internal" href="#">Object Encryption</a><ul>
<li><a class="reference internal" href="#deployment-and-operation">Deployment and operation</a><ul>
<li><a class="reference internal" href="#keymaster-middleware">Keymaster middleware</a><ul>
<li><a class="reference internal" href="#separate-keymaster-configuration-file">Separate keymaster configuration file</a></li>
<li><a class="reference internal" href="#changing-the-encryption-root-secret">Changing the encryption root secret</a></li>
</ul>
</li>
<li><a class="reference internal" href="#encryption-middleware">Encryption middleware</a></li>
<li><a class="reference internal" href="#encryption-root-secret-in-external-key-management-system">Encryption Root Secret in External Key Management System</a><ul>
<li><a class="reference internal" href="#encryption-root-secret-in-a-barbican-kms">Encryption Root Secret in a Barbican KMS</a></li>
<li><a class="reference internal" href="#encryption-root-secret-in-a-kmip-service">Encryption Root Secret in a KMIP service</a></li>
<li><a class="reference internal" href="#changing-the-encryption-root-secret-of-external-kms-s">Changing the encryption root secret of external KMS’s</a></li>
</ul>
</li>
<li><a class="reference internal" href="#upgrade-considerations">Upgrade Considerations</a></li>
<li><a class="reference internal" href="#disabling-encryption">Disabling Encryption</a></li>
<li><a class="reference internal" href="#container-sync-configuration">Container sync configuration</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementation">Implementation</a><ul>
<li><a class="reference internal" href="#encryption-scheme">Encryption scheme</a></li>
<li><a class="reference internal" href="#key-management">Key management</a></li>
<li><a class="reference internal" href="#id2">Encryption middleware</a><ul>
<li><a class="reference internal" href="#encrypter-operation">Encrypter operation</a><ul>
<li><a class="reference internal" href="#custom-user-metadata">Custom user metadata</a></li>
<li><a class="reference internal" href="#object-body">Object body</a></li>
<li><a class="reference internal" href="#entity-tag">Entity tag</a></li>
<li><a class="reference internal" href="#conditional-requests">Conditional Requests</a></li>
</ul>
</li>
<li><a class="reference internal" href="#decrypter-operation">Decrypter operation</a></li>
</ul>
</li>
<li><a class="reference internal" href="#impact-on-other-swift-services-and-features">Impact on other Swift services and features</a></li>
<li><a class="reference internal" href="#considerations-for-developers">Considerations for developers</a></li>
</ul>
</li>
</ul>
</li>
</ul>

    </div>
  </div>
  </div>
</div>
      </div>
    </div>
<footer>
  <div class="container">
    <div class="row footer-links">
      <div class="col-lg-2 col-sm-2">
        <h3>OpenStack</h3>
        <ul>
          <li><a href="https://openstack.org/projects/">Projects</a></li>
          <li><a href="https://www.openstack.org/software/security/">OpenStack Security</a></li>
          <li><a href="https://openstack.org/projects/openstack-faq/">Common Questions</a></li>
          <li><a href="https://openstack.org/blog/">Blog</a></li>g
          <li><a href="https://openstack.org/news/">News</a></li>
        </ul>
      </div>
      <div class="col-lg-2 col-sm-2">
        <h3>Community</h3>
        <ul>
          <li><a href="https://openstack.org/community/">User Groups</a></li>
          <li><a href="https://openstack.org/community/events/">Events</a></li>
          <li><a href="https://openstack.org/community/jobs/">Jobs</a></li>
          <li><a href="https://openstack.org/foundation/companies/">Companies</a></li>
          <li><a href="https://docs.openstack.org/contributors">Contribute</a></li>
        </ul>
      </div>
      <div class="col-lg-2 col-sm-2">
        <h3>Documentation</h3>
        <ul>
          <li><a href="https://docs.openstack.org">OpenStack Manuals</a></li>
          <li><a href="https://openstack.org/software/start/">Getting Started</a></li>
          <li><a href="https://developer.openstack.org">API Documentation</a></li>
          <li><a href="https://wiki.openstack.org">Wiki</a></li>
        </ul>
      </div>
      <div class="col-lg-2 col-sm-2">
        <h3>Branding & Legal</h3>
        <ul>
          <li><a href="https://openstack.org/brand/">Logos & Guidelines</a></li>
          <li><a href="https://openstack.org/brand/openstack-trademark-policy/">Trademark Policy</a></li>
          <li><a href="https://openstack.org/privacy/">Privacy Policy</a></li>
          <li><a href="https://wiki.openstack.org/wiki/How_To_Contribute#Contributor_License_Agreement">OpenStack CLA</a></li>
        </ul>
      </div>
      <div class="col-lg-4 col-sm-4">
        <h3>Stay In Touch</h3>
        <a href="https://twitter.com/OpenStack" target="_blank" class="social-icons footer-twitter"></a>
        <a href="https://www.facebook.com/openstack" target="_blank" class="social-icons footer-facebook"></a>
        <a href="https://www.linkedin.com/company/openstack" target="_blank" class="social-icons footer-linkedin"></a>
        <a href="https://www.youtube.com/user/OpenStackFoundation" target="_blank" class="social-icons footer-youtube"></a>
        <p class="fine-print">
          The OpenStack project is provided under the
          <a href="https://www.apache.org/licenses/LICENSE-2.0">Apache 2.0 license</a>. Openstack.org is powered by
          <a href="https://rackspace.com" target="_blank">Rackspace Cloud Computing</a>.
        </p>
      </div>
    </div>
  </div>
</footer>
<!-- jQuery -->
<script type="text/javascript" src="_static/js/jquery-3.2.1.min.js"></script>

<!-- Bootstrap JavaScript -->
<script type="text/javascript" src="_static/js/bootstrap.min.js"></script>

<!-- The rest of the JS -->
<script type="text/javascript" src="_static/js/navigation.js"></script>

<!-- Docs JS -->
<script type="text/javascript" src="_static/js/docs.js"></script>

<!-- standard sphinx include libraries, which allow search highlighting -->
<script type="text/javascript" src="_static/underscore.js"></script>
<script type="text/javascript" src="_static/doctools.js"></script>
<script type="text/javascript" src="_static/searchtools.js"></script>
<script type="text/javascript" src="_static/language_data.js"></script>

<script type="text/javascript">
    var DOCUMENTATION_OPTIONS = {
      URL_ROOT:    './',
      VERSION:     '0.1.0.dev10162',
      COLLAPSE_INDEX: false,
      FILE_SUFFIX: '.html',
      LINK_SUFFIX: '.html',
      SOURCELINK_SUFFIX: '.txt',
      HAS_SOURCE:  true
    };
</script>

<!-- Javascript for page -->
<script language="JavaScript">
  /* Build a description of this page including SHA, source location on git
   * repo, build time and the project's launchpad bug tag. Set the HREF of the
   * bug buttons
   */
    var lineFeed = "%0A";
    var gitURL = "Source: Can't derive source file URL";

    /* there have been cases where "pagename" wasn't set; better check for it */
    /* "giturl" is the URL of the source file on Git and is auto-generated by
     * openstackdocstheme.
     *
     * "pagename" is a standard sphinx parameter containing the name of
     * the source file, without extension.
     */

    var sourceFile = "overview_encryption" + ".rst";
    gitURL = "Source: https://opendev.org/openstack/swift/src/doc/source" + "/" + sourceFile;

    /* gitsha, project and bug_tag rely on variables in conf.py */
    var gitSha = "SHA: a7004f079a695309fcf8adab383f12c91fb86576";
    var repositoryName = "openstack/swift";
    var bugProject = "swift";
    var bugTitle = "Object Encryption in Swift";
    var fieldTags = "";
    var useStoryboard = "";

    /* "last_updated" is the build date and time. It relies on the
       conf.py variable "html_last_updated_fmt", which should include
       year/month/day as well as hours and minutes                   */
    var buildstring = "Release: 0.1.0.dev10162 on 2021-01-21 11:53:09";

    var fieldComment = encodeURI(buildstring) +
                       lineFeed + encodeURI(gitSha) +
                       lineFeed + encodeURI(gitURL) ;

    logABug(bugTitle, bugProject, fieldComment, fieldTags, repositoryName, useStoryboard);
    var currentSourceFile = "overview_encryption";
    var pdfFileName = "doc-swift.pdf";
    pdfLink(currentSourceFile, pdfFileName);
</script>


  </body>
</html>